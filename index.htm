<!DOCTYPE html>
<html lang="vi" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Soát lỗi chính tả</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              slate: { 850: "#1e293b", 900: "#0f172a", 950: "#020617" },
            },
            fontFamily: {
              sans: ['"Noto Sans"', "sans-serif"],
              serif: ['"Noto Serif"', "serif"],
            },
          },
        },
      };
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Serif:wght@400;700&display=swap");
      body {
        font-family: "Noto Sans", sans-serif;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fadeIn {
        animation: fadeIn 0.3s ease-out forwards;
      }
    </style>
  </head>
  <body
    class="bg-slate-950 text-slate-200 min-h-screen flex flex-col transition-colors duration-300"
  >
    <!-- Header -->
    <header
      class="bg-slate-900 border-b border-slate-800 sticky top-0 z-20 shadow-md"
    >
      <div
        class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between"
      >
        <div class="flex items-center gap-3">
          <div
            class="bg-blue-600 text-white p-2 rounded-lg shadow-lg shadow-blue-900/20"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              />
            </svg>
          </div>
          <div>
            <h1 class="text-xl font-bold text-slate-100 tracking-tight">
              Soát Lỗi Chính Tả
            </h1>
            <div class="text-xs text-slate-500 font-medium">v1.63</div>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <button
            id="help-btn"
            class="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors"
            title="Hướng dẫn sử dụng"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
          </button>
          <button
            id="settings-btn"
            class="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors"
            title="Cấu hình"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
          </button>
          <button
            id="export-btn"
            class="hidden px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-sm font-medium transition-colors shadow-lg shadow-emerald-900/20 flex items-center gap-2"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
              />
            </svg>
            <span class="hidden sm:inline">Xuất lỗi</span>
          </button>
          <button
            id="reset-btn"
            class="hidden px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-medium transition-colors shadow-lg shadow-blue-900/20 flex items-center gap-2"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              />
            </svg>
            <span class="hidden sm:inline">Kiểm tra file khác</span>
          </button>
          <div
            id="dict-status"
            class="hidden md:flex items-center gap-3 text-xs px-3 py-1.5 rounded-xl bg-slate-800 border border-slate-700 h-auto"
          >
            <div
              class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse flex-shrink-0"
              id="dict-dot"
            ></div>
            <div
              id="dict-text"
              class="text-slate-400 font-mono leading-tight whitespace-nowrap"
            >
              Đang tải dữ liệu...
            </div>
          </div>
        </div>
      </div>
    </header>

    <main
      class="flex-grow max-w-6xl mx-auto px-4 py-8 w-full flex flex-col gap-6 relative"
    >
      <!-- Loading Overlay -->
      <div
        id="loading-overlay"
        class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/70 backdrop-blur-sm transition-opacity"
      >
        <div
          class="bg-slate-900 border border-slate-700 rounded-2xl px-8 py-6 shadow-2xl flex flex-col items-center gap-4"
        >
          <svg
            class="animate-spin h-10 w-10 text-blue-500"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          <span class="text-lg font-medium text-slate-200 animate-pulse"
            >Đang áp dụng...</span
          >
        </div>
      </div>

      <!-- Export Modal -->
      <div
        id="export-modal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fadeIn"
      >
        <div
          class="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden"
          onclick="event.stopPropagation()"
        >
          <div
            class="flex justify-between items-center p-4 border-b border-slate-800 bg-slate-800/50"
          >
            <h3 class="text-lg font-bold text-white">Chọn kiểu xuất lỗi</h3>
            <button
              id="close-export-btn"
              class="text-slate-400 hover:text-white transition-colors"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <div class="p-6 space-y-4">
            <button
              id="export-vctve-btn"
              class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-medium transition-colors flex items-center justify-center gap-2 group"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 opacity-70 group-hover:opacity-100"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                /></svg
              >Xuất cho VCTVEGROUP
            </button>
            <button
              id="export-normal-btn"
              class="w-full py-3 px-4 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-medium transition-colors flex items-center justify-center gap-2 group"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 opacity-70 group-hover:opacity-100"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 10h16M4 14h16M4 18h16"
                /></svg
              >Xuất thông thường
            </button>
          </div>
        </div>
      </div>

      <!-- Help Modal -->
      <div
        id="help-modal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fadeIn"
      >
        <div
          class="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden"
          onclick="event.stopPropagation()"
        >
          <div
            class="flex justify-between items-center p-4 border-b border-slate-800 bg-slate-800/50"
          >
            <h3 class="text-lg font-bold text-white flex items-center gap-2">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 text-blue-500"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                /></svg
              >Hướng Dẫn Sử Dụng
            </h3>
            <button
              id="close-help-btn"
              class="text-slate-400 hover:text-white transition-colors"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <div class="p-5 space-y-4 text-sm text-slate-300">
            <div>
              <h4 class="font-bold text-white mb-1">1. Quy Trình</h4>
              <ul class="list-disc pl-5 space-y-1 marker:text-blue-500">
                <li>Tải lên file <code>.epub</code>.</li>
                <li>Hệ thống tự động quét lỗi.</li>
                <li>Xem danh sách lỗi cột trái, ngữ cảnh cột phải.</li>
              </ul>
            </div>
            <div>
              <h4 class="font-bold text-white mb-1">2. Phím Tắt</h4>
              <div
                class="grid grid-cols-2 gap-2 text-xs bg-slate-800 p-3 rounded-lg"
              >
                <div class="flex items-center gap-2">
                  <kbd
                    class="bg-slate-700 px-2 py-0.5 rounded border border-slate-600"
                    >⬆️</kbd
                  ><span>Lên</span>
                </div>
                <div class="flex items-center gap-2">
                  <kbd
                    class="bg-slate-700 px-2 py-0.5 rounded border border-slate-600"
                    >⬇️</kbd
                  ><span>Xuống</span>
                </div>
                <div class="flex items-center gap-2 col-span-2">
                  <kbd
                    class="bg-slate-700 px-2 py-0.5 rounded border border-slate-600"
                    >Del</kbd
                  ><span class="opacity-50">/</span
                  ><kbd
                    class="bg-slate-700 px-2 py-0.5 rounded border border-slate-600"
                    >I</kbd
                  ><span>Bỏ qua từ</span>
                </div>
              </div>
            </div>
            <div>
              <h4 class="font-bold text-white mb-1">3. Tính Năng</h4>
              <ul class="list-disc pl-5 space-y-1 marker:text-green-500">
                <li><strong>Whitelist:</strong> Nhập từ bỏ qua vào ô text.</li>
                <li><strong>Lọc Tiếng Anh:</strong> Ẩn từ tiếng Anh chuẩn.</li>
                <li><strong>Cấu Hình:</strong> Bật/tắt loại lỗi.</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Modal -->
      <div
        id="settings-modal"
        class="hidden absolute top-0 right-4 z-50 w-80 bg-slate-900 border border-slate-700 rounded-xl shadow-2xl p-5 animate-fadeIn"
      >
        <div
          class="flex justify-between items-center mb-4 pb-2 border-b border-slate-800"
        >
          <h3 class="text-lg font-bold text-white">Cấu hình kiểm tra</h3>
          <button
            id="close-settings-btn"
            class="text-slate-500 hover:text-white"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-300"
              >Lỗi không có trong từ điển</span
            ><label
              for="set-dict"
              class="relative inline-block w-10 h-6 cursor-pointer"
              ><input
                type="checkbox"
                id="set-dict"
                class="sr-only peer"
                checked />
              <div
                class="w-10 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"
              ></div
            ></label>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-300">Lỗi viết hoa (VD: tÔI)</span
            ><label
              for="set-case"
              class="relative inline-block w-10 h-6 cursor-pointer"
              ><input
                type="checkbox"
                id="set-case"
                class="sr-only peer"
                checked />
              <div
                class="w-10 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"
              ></div
            ></label>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-300">Lỗi đặt dấu (Hòa/Hoà)</span
            ><label
              for="set-tone"
              class="relative inline-block w-10 h-6 cursor-pointer"
              ><input
                type="checkbox"
                id="set-tone"
                class="sr-only peer"
                checked />
              <div
                class="w-10 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"
              ></div
            ></label>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-300">Lỗi ký tự lạ / Cấu trúc</span
            ><label
              for="set-struct"
              class="relative inline-block w-10 h-6 cursor-pointer"
              ><input
                type="checkbox"
                id="set-struct"
                class="sr-only peer"
                checked />
              <div
                class="w-10 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"
              ></div
            ></label>
          </div>
        </div>
        <div class="mt-4 pt-3 border-t border-slate-800 text-xs text-slate-500">
          <p class="mb-1 font-bold text-slate-400">Phím tắt:</p>
          <div class="grid grid-cols-2 gap-2">
            <div>⬆️ ⬇️ : Di chuyển</div>
            <div>Delete / I : Bỏ qua</div>
          </div>
        </div>
      </div>

      <div
        id="upload-section"
        class="bg-slate-900 rounded-2xl shadow-xl border-2 border-dashed border-slate-800 p-12 text-center transition-all hover:border-blue-500/50 hover:bg-slate-800/50 group cursor-pointer relative overflow-hidden"
      >
        <input type="file" id="file-input" accept=".epub" class="hidden" />
        <div
          class="absolute inset-0 bg-gradient-to-br from-blue-500/5 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity"
        ></div>
        <div
          class="relative z-10 flex flex-col items-center justify-center gap-6 pointer-events-none"
        >
          <div
            class="w-20 h-20 bg-slate-800 text-blue-500 rounded-full flex items-center justify-center group-hover:scale-110 group-hover:bg-slate-700 group-hover:text-blue-400 transition-all duration-300 shadow-lg shadow-black/20"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-10 w-10"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
              />
            </svg>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-slate-200">Tải lên sách</h2>
            <p class="text-slate-400 mt-2 text-lg">
              Kéo thả hoặc nhấp để chọn tệp
            </p>
          </div>
        </div>
      </div>

      <div
        id="processing-ui"
        class="hidden bg-slate-900 p-8 rounded-2xl shadow-xl border border-slate-800 max-w-2xl mx-auto w-full"
      >
        <div class="flex justify-between items-end mb-4">
          <div>
            <h3 class="text-lg font-semibold text-white mb-1">
              Đang phân tích
            </h3>
            <div id="status-text" class="text-slate-400 text-sm">
              Đang khởi tạo...
            </div>
          </div>
          <span id="progress-percent" class="text-3xl font-bold text-blue-500"
            >0%</span
          >
        </div>
        <div
          class="w-full bg-slate-800 rounded-full h-3 overflow-hidden box-border border border-slate-700/50"
        >
          <div
            id="progress-bar"
            class="bg-gradient-to-r from-blue-600 to-indigo-600 h-full rounded-full transition-all duration-300 shadow-[0_0_10px_rgba(37,99,235,0.5)]"
            style="width: 0%"
          ></div>
        </div>
      </div>

      <div id="results-section" class="hidden flex flex-col gap-6">
        <div
          class="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-lg flex items-center gap-5 relative overflow-hidden min-h-[140px]"
        >
          <div
            class="absolute right-0 top-0 p-6 opacity-10 pointer-events-none"
          >
            <svg
              class="w-40 h-40 text-white"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1"
                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
              />
            </svg>
          </div>
          <div
            class="w-20 h-28 bg-slate-800 rounded-lg flex-shrink-0 border border-slate-700 overflow-hidden relative shadow-md"
          >
            <img
              id="meta-cover"
              class="w-full h-full object-cover hidden"
              alt="Bìa sách"
            />
            <div
              id="meta-cover-placeholder"
              class="w-full h-full flex items-center justify-center text-slate-600"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-8 w-8"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
                />
              </svg>
            </div>
          </div>
          <div class="relative z-10">
            <div
              class="text-xs text-blue-400 font-bold uppercase tracking-wider mb-1"
            >
              Đang kiểm tra
            </div>
            <h2
              id="meta-title"
              class="text-2xl font-bold text-white leading-tight"
            >
              Đang tải...
            </h2>
            <p
              id="meta-author"
              class="text-slate-400 mt-1 font-serif italic text-lg"
            >
              Đang tải...
            </p>
          </div>
        </div>

        <div
          class="bg-slate-900 p-5 rounded-xl border border-slate-800 shadow-lg"
        >
          <div class="flex items-center justify-between mb-3">
            <label
              for="whitelist-input"
              class="flex items-center gap-2 text-sm font-bold text-slate-300"
              ><svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4 text-green-500"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                /></svg
              >Danh sách từ bỏ soát lỗi</label
            >
            <span class="text-xs text-slate-500"
              >Tự động cập nhật & lưu kết quả</span
            >
          </div>
          <textarea
            id="whitelist-input"
            rows="2"
            class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-slate-200 text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500 placeholder-slate-600 transition-colors"
            placeholder="Nhập các từ muốn bỏ qua..."
          ></textarea>
          <div
            class="flex items-center gap-2 mt-4 pt-3 border-t border-slate-800"
          >
            <input
              type="checkbox"
              id="eng-filter-checkbox"
              class="w-4 h-4 text-blue-600 rounded bg-slate-800 border-slate-600 focus:ring-blue-500 focus:ring-offset-slate-900"
            />
            <label
              for="eng-filter-checkbox"
              class="text-sm font-medium text-slate-300 cursor-pointer select-none flex items-center gap-2"
            >
              Kích hoạt từ tiếng Anh
              <span
                id="eng-loading"
                class="hidden text-xs text-yellow-500 animate-pulse flex items-center gap-1"
                ><svg
                  class="animate-spin h-3 w-3"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
                Đang tải...</span
              >
            </label>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div
            class="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-lg relative overflow-hidden"
          >
            <div class="absolute right-0 top-0 p-4 opacity-5">
              <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 20 20">
                <path
                  d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.968 7.968 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"
                />
              </svg>
            </div>
            <div
              class="text-slate-500 text-sm font-medium mb-1 uppercase tracking-wider"
            >
              Từ đã quét
            </div>
            <div
              id="stat-total-words"
              class="text-3xl font-bold text-slate-100"
            >
              0
            </div>
          </div>
          <div
            class="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-lg relative overflow-hidden group"
          >
            <div class="absolute right-0 top-0 p-4 opacity-5 text-red-500">
              <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <div
              class="text-red-400 text-sm font-medium mb-1 uppercase tracking-wider"
            >
              Lỗi phát hiện
            </div>
            <div
              id="stat-errors"
              class="text-3xl font-bold text-red-500 group-hover:scale-105 transition-transform origin-left"
            >
              0
            </div>
          </div>
          <div
            class="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-lg relative overflow-hidden"
          >
            <div class="absolute right-0 top-0 p-4 opacity-5 text-blue-500">
              <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 20 20">
                <path
                  d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"
                />
              </svg>
            </div>
            <div
              class="text-blue-400 text-sm font-medium mb-1 uppercase tracking-wider"
            >
              Nhóm lỗi
            </div>
            <div id="stat-groups" class="text-3xl font-bold text-blue-400">
              0
            </div>
          </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-6 h-[600px] lg:h-[700px]">
          <div
            class="w-full lg:w-1/3 flex flex-col bg-slate-900 rounded-2xl border border-slate-800 shadow-xl overflow-hidden"
          >
            <div
              class="p-4 border-b border-slate-800 bg-slate-900/50 backdrop-blur font-semibold text-slate-300 flex justify-between items-center"
            >
              <span class="flex items-center gap-2"
                ><svg
                  class="w-4 h-4 text-slate-500"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6h16M4 10h16M4 14h16M4 18h16"
                  /></svg
                >Danh sách lỗi</span
              >
              <select
                id="sort-select"
                class="text-xs px-2 py-1 rounded bg-slate-800 text-slate-500 border border-slate-700 focus:outline-none focus:border-blue-500 cursor-pointer"
              >
                <option value="count_desc">Số lượng (Cao → Thấp)</option>
                <option value="count_asc">Số lượng (Thấp → Cao)</option>
                <option value="alpha_asc">A → Z</option>
                <option value="alpha_desc">Z → A</option>
                <option value="severity">Mức độ nghiêm trọng</option>
              </select>
            </div>
            <div
              id="error-list"
              class="flex-1 overflow-y-auto p-2 space-y-1 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent"
            ></div>
          </div>
          <div
            class="w-full lg:w-2/3 flex flex-col bg-slate-900 rounded-2xl border border-slate-800 shadow-xl overflow-hidden"
          >
            <div
              class="p-4 border-b border-slate-800 bg-slate-900/50 backdrop-blur font-semibold text-slate-300 flex justify-between items-center"
            >
              <span class="flex items-center gap-2"
                ><svg
                  class="w-4 h-4 text-slate-500"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                  /></svg
                >Ngữ cảnh</span
              >
              <div
                id="context-nav"
                class="hidden flex items-center gap-2 text-sm bg-slate-800 rounded-lg p-1 border border-slate-700"
              >
                <button
                  id="btn-prev"
                  class="p-1.5 hover:bg-slate-700 rounded-md text-slate-400 hover:text-white disabled:opacity-30 transition-colors"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </button>
                <span
                  id="nav-indicator"
                  class="font-mono text-slate-300 min-w-[3rem] text-center text-xs"
                  >1/1</span
                >
                <button
                  id="btn-next"
                  class="p-1.5 hover:bg-slate-700 rounded-md text-slate-400 hover:text-white disabled:opacity-30 transition-colors"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </button>
              </div>
            </div>
            <div
              id="context-view"
              class="flex-1 p-8 overflow-y-auto flex flex-col items-center justify-center text-slate-500 bg-slate-950/50 relative"
            >
              <div
                class="text-center p-6 border-2 border-dashed border-slate-800 rounded-xl"
              >
                <p class="text-lg mb-2">Chưa chọn lỗi nào</p>
                <p class="text-sm opacity-60">
                  Chọn một mục từ danh sách bên trái
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer
      class="mt-auto py-6 text-center text-white text-sm border-t border-slate-900 bg-slate-950"
    >
      <p class="font-medium">-Akhademik 2025-</p>
    </footer>

    <!-- Templates -->
    <template id="error-item-template">
      <div
        class="w-full flex items-stretch rounded-lg hover:bg-slate-800 group transition-all mb-1 bg-slate-900 border border-transparent hover:border-slate-700"
      >
        <button
          class="select-btn flex-grow text-left px-4 py-3 flex items-center justify-between focus:outline-none rounded-l-lg border-r border-slate-800/50 group-hover:border-slate-700"
        >
          <div class="overflow-hidden w-full">
            <div class="flex items-center gap-2">
              <span
                class="status-dot w-2.5 h-2.5 rounded-full flex-shrink-0 shadow-[0_0_5px_rgba(0,0,0,0.5)]"
              ></span>
              <span
                class="font-bold text-slate-200 error-word text-lg truncate font-serif"
              ></span>
              <span
                class="bg-slate-800 text-slate-400 border border-slate-700 text-[10px] font-bold px-2 py-0.5 rounded-full error-count flex-shrink-0"
              ></span>
            </div>
            <div
              class="text-xs text-slate-500 mt-1 error-reason truncate"
            ></div>
          </div>
        </button>
        <button
          class="ignore-btn px-3 flex items-center justify-center text-slate-600 hover:text-green-400 hover:bg-slate-800/50 rounded-r-lg transition-colors"
          title="Bỏ qua (Whitelist)"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"
            />
          </svg>
        </button>
      </div>
    </template>

    <script>
      // --- 1. CONFIGURATION ---
      const ENG_DICT_URL =
        "https://raw.githubusercontent.com/akhademik/epub-spell-check/main/en-dict.txt";
      const DICT_URL =
        "https://raw.githubusercontent.com/akhademik/epub-spell-check/main/vn-dict.txt";
      const CUSTOM_DICT_URL =
        "https://raw.githubusercontent.com/akhademik/epub-spell-check/main/custom-dict.txt";
      const STORAGE_KEY = "vn_spell_whitelist";
      const SETTINGS_KEY = "vn_spell_settings";
      const IGNORED_WORDS = new Set([]);
      const TONE_MISPLACEMENT = {
        oá: "óa",
        oà: "òa",
        oả: "ỏa",
        oã: "õa",
        oạ: "ọa",
        oé: "óe",
        oè: "òe",
        oẻ: "ỏe",
        oẽ: "õe",
        oẹ: "ọe",
      };
      const localWordRegex = /[\p{L}\p{M}]+/gu;

      // --- 2. DOM ELEMENTS ---
      const UI = {
        fileInput: document.getElementById("file-input"),
        uploadSection: document.getElementById("upload-section"),
        processingUi: document.getElementById("processing-ui"),
        progressBar: document.getElementById("progress-bar"),
        progressPercent: document.getElementById("progress-percent"),
        statusText: document.getElementById("status-text"),
        resultsSection: document.getElementById("results-section"),
        errorList: document.getElementById("error-list"),
        contextView: document.getElementById("context-view"),
        metaTitle: document.getElementById("meta-title"),
        metaAuthor: document.getElementById("meta-author"),
        metaCover: document.getElementById("meta-cover"),
        metaCoverPlaceholder: document.getElementById("meta-cover-placeholder"),
        whitelistInput: document.getElementById("whitelist-input"),
        resetBtn: document.getElementById("reset-btn"),
        exportBtn: document.getElementById("export-btn"),
        engFilterCheckbox: document.getElementById("eng-filter-checkbox"),
        settingsBtn: document.getElementById("settings-btn"),
        settingsModal: document.getElementById("settings-modal"),
        closeSettingsBtn: document.getElementById("close-settings-btn"),
        helpBtn: document.getElementById("help-btn"),
        helpModal: document.getElementById("help-modal"),
        closeHelpBtn: document.getElementById("close-help-btn"),
        exportModal: document.getElementById("export-modal"),
        closeExportBtn: document.getElementById("close-export-btn"),
        exportVctveBtn: document.getElementById("export-vctve-btn"),
        exportNormalBtn: document.getElementById("export-normal-btn"),
        dictStatus: document.getElementById("dict-status"),
        dictDot: document.getElementById("dict-dot"),
        dictText: document.getElementById("dict-text"),
        contextNav: document.getElementById("context-nav"),
        btnPrev: document.getElementById("btn-prev"),
        btnNext: document.getElementById("btn-next"),
        navIndicator: document.getElementById("nav-indicator"),
        statTotalWords: document.getElementById("stat-total-words"),
        statErrors: document.getElementById("stat-errors"),
        statGroups: document.getElementById("stat-groups"),
        loadingOverlay: document.getElementById("loading-overlay"),
        sortSelect: document.getElementById("sort-select"),
      };

      // --- 3. STATE ---
      let state = {
        allDetectedErrors: [],
        currentFilteredErrors: [],
        currentGroup: null,
        currentInstanceIndex: 0,
        validSyllables: new Set(),
        engWords: new Set(),
        customWords: new Set(),
        isDictLoaded: false,
        isEngDictLoaded: false,
        isEngFilterEnabled: false,
        isEngDictLoading: false,
        currentCoverUrl: null,
        currentBookTitle: "",
        loadedTextContent: [],
        checkSettings: {
          dictionary: true,
          uppercase: true,
          tone: true,
          foreign: true,
        },
        sortMode: "count_desc",
      };

      // --- 4. UTILS & HELPERS ---
      const isFrontVowel = (c) =>
        c &&
        ["i", "e", "ê"].includes(
          c
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toLowerCase()
        );
      const isY = (c) =>
        c &&
        c
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "") === "y";

      function getSeverityScore(type) {
        if (!type) return 0;
        if (
          type.startsWith("Sai quy tắc") ||
          type.includes("Lỗi gõ máy") ||
          type.includes("Lỗi viết hoa")
        )
          return 4;
        if (type.includes("Sai vị trí dấu")) return 3;
        if (type.includes("Từ lạ") || type.includes("ký tự lạ")) return 2;
        return 1;
      }

      function getErrorHighlights(type) {
        let style = {
          dot: "bg-sky-500",
          text: "text-sky-400",
          bg: "bg-sky-500/20",
          border: "border-sky-500",
        };
        if (!type) return style;
        if (
          type.startsWith("Sai quy tắc") ||
          type.includes("Lỗi gõ máy") ||
          type.includes("Lỗi viết hoa")
        ) {
          style = {
            dot: "bg-red-500",
            text: "text-red-400",
            bg: "bg-red-500/20",
            border: "border-red-500",
          };
        } else if (type.includes("Sai vị trí dấu")) {
          style = {
            dot: "bg-orange-500",
            text: "text-orange-400",
            bg: "bg-orange-500/20",
            border: "border-orange-500",
          };
        } else if (type.includes("Từ lạ") || type.includes("ký tự lạ")) {
          style = {
            dot: "bg-pink-500",
            text: "text-pink-400",
            bg: "bg-pink-500/20",
            border: "border-pink-500",
          };
        }
        return style;
      }

      function levenshteinDistance(a, b) {
        if (a.length === 0) return b.length;
        if (b.length === 0) return a.length;
        let row = new Array(a.length + 1);
        for (let j = 0; j <= a.length; j++) row[j] = j;
        for (let i = 1; i <= b.length; i++) {
          let prev = row[0];
          row[0] = i;
          for (let j = 1; j <= a.length; j++) {
            const temp = row[j];
            row[j] = Math.min(
              prev + (b.charAt(i - 1) === a.charAt(j - 1) ? 0 : 1),
              Math.min(row[j] + 1, row[j - 1] + 1)
            );
            prev = temp;
          }
        }
        return row[a.length];
      }

      function findSuggestions(w) {
        const low = w.toLowerCase();
        for (const [wr, r] of Object.entries(TONE_MISPLACEMENT)) {
          if (low.includes(wr)) return [low.replace(wr, r)];
        }
        if (!state.isDictLoaded) return [];
        const sugg = [];
        const maxDist = w.length < 4 ? 1 : 2;
        for (const v of state.validSyllables) {
          if (Math.abs(v.length - low.length) > maxDist) continue;
          const d = levenshteinDistance(low, v);
          if (d <= maxDist && d > 0) sugg.push({ word: v, dist: d });
        }
        return sugg
          .sort((a, b) => a.dist - b.dist)
          .slice(0, 5)
          .map((s) => s.word);
      }

      function getContext(text, index, length) {
        const start = Math.max(0, index - 60);
        const end = Math.min(text.length, index + length + 60);
        return {
          prefix: text.substring(start, index),
          target: text.substr(index, length),
          suffix: text.substring(index + length, end),
        };
      }

      function escapeHtml(text) {
        const d = document.createElement("div");
        d.textContent = text;
        return d.innerHTML;
      }
      function updateProgress(p, t) {
        UI.progressBar.style.width = p + "%";
        UI.progressPercent.innerText = p + "%";
        UI.statusText.innerText = t;
      }

      function showToast(msg) {
        const n = document.createElement("div");
        n.className =
          "fixed bottom-6 right-6 bg-slate-800 text-green-400 border border-slate-700 px-4 py-3 rounded-lg shadow-xl z-[70] text-sm font-medium animate-fadeIn flex items-center gap-2";
        n.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg><span>${msg}</span>`;
        document.body.appendChild(n);
        setTimeout(() => {
          n.style.opacity = "0";
          n.style.transition = "opacity 0.5s";
          setTimeout(() => n.remove(), 500);
        }, 2000);
      }

      function copyToClipboard(text) {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.style.position = "fixed";
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand("copy");
          showToast(`Đã copy: "${text}"`);
        } catch (err) {}
        document.body.removeChild(textarea);
      }

      // --- 5. LOGIC & EVENT LISTENERS ---
      async function fetchDictWithFallback(filename, onlineUrl) {
        try {
          const res = await fetch(filename);
          if (res.ok) return await res.text();
        } catch (e) {}
        const res = await fetch(onlineUrl);
        if (!res.ok) throw new Error("Load failed");
        return await res.text();
      }

      async function loadDictionaries() {
        try {
          UI.dictStatus.classList.remove("hidden");
          UI.dictText.innerText = "Đang tải dữ liệu...";
          const [vnRes, enRes, upRes] = await Promise.all([
            fetchDictWithFallback("vn-dict.txt", DICT_URL),
            fetchDictWithFallback("en-dict.txt", ENG_DICT_URL),
            fetchDictWithFallback("custom-dict.txt", CUSTOM_DICT_URL).catch(
              () => null
            ),
          ]);

          if (vnRes) {
            vnRes.split("\n").forEach((line) => {
              let w = line.trim();
              if (!w) return;
              if (w.startsWith("{") && w.endsWith("}")) {
                try {
                  w = JSON.parse(w).text;
                } catch (e) {}
              }
              const clean = w.toLowerCase().normalize("NFC");
              if (clean)
                clean.split(/\s+/).forEach((p) => state.validSyllables.add(p));
            });
            [
              "kỹ",
              "mỹ",
              "kì",
              "lí",
              "qui",
              "có",
              "hắn",
              "y",
              "gã",
              "thị",
              "nó",
              "ta",
              "ngươi",
              "chư",
              "mỗ",
              "tại",
              "bị",
              "bởi",
              "chăng",
            ].forEach((w) => state.validSyllables.add(w.normalize("NFC")));
            state.isDictLoaded = true;
          }
          if (enRes) {
            enRes.split(/\r?\n/).forEach((w) => {
              const c = w.trim().toLowerCase();
              if (c) state.engWords.add(c);
            });
            state.isEngDictLoaded = true;
          }
          if (upRes) {
            upRes.split(/\r?\n/).forEach((w) => {
              const c = w.trim();
              if (c) state.customWords.add(c);
            });
          }

          UI.dictDot.classList.remove("bg-yellow-500", "animate-pulse");
          if (state.isDictLoaded) {
            UI.dictDot.classList.add("bg-green-500");
            UI.dictText.innerHTML = `<div class="flex flex-col items-start leading-snug"><span>VN: ${state.validSyllables.size.toLocaleString()} từ</span><span>EN: ${state.engWords.size.toLocaleString()} từ</span></div>`;
          } else {
            UI.dictDot.classList.add("bg-red-500");
            UI.dictText.innerText = "Lỗi tải dữ liệu";
          }
        } catch (err) {
          console.error(err);
          UI.dictDot.classList.remove("bg-yellow-500", "animate-pulse");
          UI.dictDot.classList.add("bg-red-500");
          UI.dictText.innerText = "Lỗi kết nối";
        }
      }

      function loadWhitelist() {
        const s = localStorage.getItem(STORAGE_KEY);
        if (s) UI.whitelistInput.value = s;
      }
      function saveWhitelist() {
        localStorage.setItem(STORAGE_KEY, UI.whitelistInput.value);
      }
      function loadSettings() {
        const s = localStorage.getItem(SETTINGS_KEY);
        if (s) {
          state.checkSettings = JSON.parse(s);
          document.getElementById("set-dict").checked =
            state.checkSettings.dictionary;
          document.getElementById("set-case").checked =
            state.checkSettings.uppercase;
          document.getElementById("set-tone").checked =
            state.checkSettings.tone;
          document.getElementById("set-struct").checked =
            state.checkSettings.foreign;
        }
      }
      function saveSettings() {
        state.checkSettings = {
          dictionary: document.getElementById("set-dict").checked,
          uppercase: document.getElementById("set-case").checked,
          tone: document.getElementById("set-tone").checked,
          foreign: document.getElementById("set-struct").checked,
        };
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(state.checkSettings));
        if (state.loadedTextContent.length > 0) {
          UI.loadingOverlay.classList.remove("hidden");
          setTimeout(() => {
            analyzeText(state.loadedTextContent);
            UI.loadingOverlay.classList.add("hidden");
          }, 50);
        }
      }

      async function handleFile(file) {
        if (!file.name.endsWith(".epub")) {
          alert("Vui lòng chọn file .epub");
          return;
        }
        state.isEngFilterEnabled = UI.engFilterCheckbox.checked;
        UI.uploadSection.classList.add("hidden");
        UI.resultsSection.classList.add("hidden");
        UI.processingUi.classList.remove("hidden");
        UI.errorList.innerHTML = "";
        UI.contextView.innerHTML =
          '<div class="text-center p-6 border-2 border-dashed border-slate-800 rounded-xl"><p class="text-lg mb-2">Chưa chọn lỗi nào</p><p class="text-sm opacity-60">Chọn một mục từ danh sách bên trái</p></div>';
        UI.contextNav.classList.add("hidden");
        UI.metaTitle.innerText = "Đang tải...";
        UI.metaAuthor.innerText = "Đang tải...";
        if (state.currentCoverUrl) {
          URL.revokeObjectURL(state.currentCoverUrl);
          state.currentCoverUrl = null;
        }
        UI.metaCover.src = "";
        UI.metaCover.classList.add("hidden");
        UI.metaCoverPlaceholder.classList.remove("hidden");
        try {
          updateProgress(10, "Đang giải nén tệp...");
          const zip = await JSZip.loadAsync(file);
          updateProgress(30, "Đang đọc cấu trúc sách...");
          const { fullTextBlocks, title, author, coverUrl } = await parseEpub(
            zip
          );
          state.loadedTextContent = fullTextBlocks;
          UI.metaTitle.innerText = title;
          UI.metaAuthor.innerText = author;
          state.currentBookTitle = title;
          if (coverUrl) {
            state.currentCoverUrl = coverUrl;
            UI.metaCover.src = coverUrl;
            UI.metaCover.classList.remove("hidden");
            UI.metaCoverPlaceholder.classList.add("hidden");
          }
          updateProgress(60, "Đang phân tích...");
          requestAnimationFrame(() => {
            setTimeout(() => {
              analyzeText(fullTextBlocks);
              UI.processingUi.classList.add("hidden");
              UI.resultsSection.classList.remove("hidden");
              UI.resetBtn.classList.remove("hidden");
              UI.exportBtn.classList.remove("hidden");
            }, 100);
          });
        } catch (err) {
          console.error(err);
          alert("Có lỗi xảy ra: " + err.message);
          UI.processingUi.classList.add("hidden");
          UI.uploadSection.classList.remove("hidden");
        }
      }

      async function parseEpub(zip) {
        const cData = await zip.file("META-INF/container.xml").async("string");
        const parser = new DOMParser();
        const cXml = parser.parseFromString(cData, "application/xml");
        const rootPath = cXml
          .querySelector("rootfile")
          .getAttribute("full-path");
        const opfData = await zip.file(rootPath).async("string");
        const opfXml = parser.parseFromString(opfData, "application/xml");
        const opfDir = rootPath.substring(0, rootPath.lastIndexOf("/"));
        const resolvePath = (p) => (opfDir ? opfDir + "/" + p : p);
        const title =
          opfXml.getElementsByTagName("dc:title")[0]?.textContent ||
          opfXml.querySelector("title")?.textContent ||
          "Không rõ tên sách";
        const author =
          opfXml.getElementsByTagName("dc:creator")[0]?.textContent ||
          opfXml.querySelector("creator")?.textContent ||
          "Không rõ tác giả";
        let coverUrl = null;
        try {
          let coverHref = null;
          const coverMeta = opfXml.querySelector('meta[name="cover"]');
          if (coverMeta) {
            const coverId = coverMeta.getAttribute("content");
            const coverItem = opfXml.querySelector(
              `manifest item[id="${coverId}"]`
            );
            if (coverItem) coverHref = coverItem.getAttribute("href");
          }
          if (!coverHref) {
            const coverItem = opfXml.querySelector(
              'manifest item[properties*="cover-image"]'
            );
            if (coverItem) coverHref = coverItem.getAttribute("href");
          }
          if (coverHref) {
            const fullCoverPath = resolvePath(coverHref);
            const coverFile = zip.file(fullCoverPath);
            if (coverFile) {
              const coverBlob = await coverFile.async("blob");
              coverUrl = URL.createObjectURL(coverBlob);
            }
          }
        } catch (e) {}
        const spine = Array.from(opfXml.querySelectorAll("spine itemref")).map(
          (ref) => ref.getAttribute("idref")
        );
        const manifest = {};
        Array.from(opfXml.querySelectorAll("manifest item")).forEach(
          (item) =>
            (manifest[item.getAttribute("id")] = item.getAttribute("href"))
        );
        let fullTextBlocks = [];
        for (let i = 0; i < spine.length; i++) {
          const href = manifest[spine[i]];
          const fullPath = resolvePath(href);
          if (zip.file(fullPath)) {
            const html = await zip.file(fullPath).async("string");
            const doc = parser.parseFromString(html, "text/html");
            const paras = Array.from(
              doc.querySelectorAll("p, h1, h2, h3, h4, h5, h6, li, div")
            )
              .map((el) => el.textContent.trim())
              .filter((text) => text.length > 0);
            fullTextBlocks.push(...paras);
          }
          if (i % 5 === 0)
            updateProgress(
              30 + Math.round((i / spine.length) * 30),
              `Đang đọc chương ${i + 1}/${spine.length}`
            );
        }
        return { fullTextBlocks, title, author, coverUrl };
      }

      function analyzeText(paragraphs) {
        let totalWords = 0;
        const errorMap = new Map();
        paragraphs.forEach((para) => {
          let match;
          while ((match = localWordRegex.exec(para)) !== null) {
            const word = match[0];
            totalWords++;
            if (word.length < 2) continue;

            if (state.customWords.has(word)) continue;

            const lower = word.toLowerCase().normalize("NFC");
            const isCapitalized = /^[A-Z\u00C0-\u00DE]/.test(word);
            let errorType = null;
            if (state.checkSettings.uppercase) {
              const upperCount = Array.from(word).filter(
                (c) => c.toUpperCase() === c && c.toLowerCase() !== c
              ).length;
              if (upperCount >= 2) errorType = "Lỗi viết hoa (Nhiều ký tự hoa)";
            }
            if (!errorType && state.checkSettings.tone) {
              for (const [wrong, right] of Object.entries(TONE_MISPLACEMENT)) {
                if (lower.endsWith(wrong)) {
                  errorType = "Sai vị trí dấu (Chuẩn cũ/mới)";
                  break;
                }
              }
            }
            if (
              !errorType &&
              state.isDictLoaded &&
              state.checkSettings.dictionary
            ) {
              if (!state.validSyllables.has(lower)) {
                if (!isCapitalized) {
                  if (/[fjwz]/.test(lower)) {
                    if (state.checkSettings.foreign)
                      errorType = "Từ lạ / Tiếng nước ngoài";
                    else errorType = "Không có trong từ điển";
                  } else if (/(aa|ee|oo|dd|js|kx|wt)$/.test(lower)) {
                    errorType = "Lỗi gõ máy (Typo)";
                  } else {
                    errorType = "Không có trong từ điển";
                  }
                }
              }
            } else if (
              !errorType &&
              state.checkSettings.foreign &&
              /[fjwz]/.test(lower) &&
              !isCapitalized
            ) {
              errorType = "Chứa ký tự lạ (f, j, w, z)";
            }

            const isWordInDict =
              state.isDictLoaded && state.validSyllables.has(lower);
            if (!errorType && state.checkSettings.foreign && !isWordInDict) {
              if (
                lower.startsWith("ngh") &&
                !isFrontVowel(lower[3]) &&
                !isCapitalized
              )
                errorType = "Sai quy tắc ngh";
              else if (
                lower.startsWith("ng") &&
                isFrontVowel(lower[2]) &&
                !isCapitalized
              )
                errorType = "Sai quy tắc ng";
              else if (
                lower.startsWith("gh") &&
                !isFrontVowel(lower[2]) &&
                !isCapitalized
              )
                errorType = "Sai quy tắc gh";
              else if (
                lower.startsWith("g") &&
                !lower.startsWith("gh") &&
                !lower.startsWith("gi") &&
                !isCapitalized
              ) {
                const c = lower[1];
                if (
                  c &&
                  ["e", "ê"].includes(
                    c
                      .normalize("NFD")
                      .replace(/[\u0300-\u036f]/g, "")
                      .toLowerCase()
                  )
                )
                  errorType = "Sai quy tắc g";
              } else if (
                lower.startsWith("k") &&
                !lower.startsWith("kh") &&
                !isFrontVowel(lower[1]) &&
                !isY(lower[1]) &&
                !isCapitalized
              )
                errorType = "Sai quy tắc k";
              else if (
                lower.startsWith("c") &&
                !lower.startsWith("ch") &&
                (isFrontVowel(lower[1]) || isY(lower[1])) &&
                !isCapitalized
              )
                errorType = "Sai quy tắc c";
            }
            if (errorType) {
              const key = lower + "::" + errorType;
              if (!errorMap.has(key))
                errorMap.set(key, {
                  id: key,
                  word: word,
                  type: errorType,
                  contexts: [],
                });
              errorMap
                .get(key)
                .contexts.push(getContext(para, match.index, word.length));
            }
          }
        });
        UI.statTotalWords.innerText = totalWords.toLocaleString();
        state.allDetectedErrors = Array.from(errorMap.values()).sort(
          (a, b) => b.contexts.length - a.contexts.length
        );
        state.currentFilteredErrors = state.allDetectedErrors;
        filterAndRenderErrors();
      }

      function filterAndRenderErrors() {
        const rawInput = UI.whitelistInput.value;
        const userWhitelist = new Set();
        if (rawInput)
          rawInput
            .split(/[\n,\t]+/)
            .map((t) => t.trim().toLowerCase())
            .filter((t) => t.length > 0)
            .forEach((t) => userWhitelist.add(t));
        let filtered = state.allDetectedErrors.filter(
          (g) => !userWhitelist.has(g.word.toLowerCase())
        );
        if (state.isEngFilterEnabled && state.isEngDictLoaded)
          filtered = filtered.filter(
            (g) => !state.engWords.has(g.word.toLowerCase())
          );
        if (state.sortMode === "alphabet") {
          const collator = new Intl.Collator("vi", {
            sensitivity: "accent",
            numeric: true,
          });
          filtered.sort((a, b) => collator.compare(a.word, b.word));
        } else if (state.sortMode === "alpha_desc") {
          const collator = new Intl.Collator("vi", {
            sensitivity: "accent",
            numeric: true,
          });
          filtered.sort((a, b) => collator.compare(b.word, a.word));
        } else if (state.sortMode === "count_asc") {
          filtered.sort((a, b) => a.contexts.length - b.contexts.length);
        } else {
          filtered.sort((a, b) => {
            const scoreA = getSeverityScore(a.type);
            const scoreB = getSeverityScore(b.type);
            if (scoreA !== scoreB) return scoreB - scoreA;
            return b.contexts.length - a.contexts.length;
          });
        }
        state.currentFilteredErrors = filtered;
        UI.statErrors.innerText = filtered
          .reduce((acc, curr) => acc + curr.contexts.length, 0)
          .toLocaleString();
        UI.statGroups.innerText = filtered.length.toLocaleString();
        renderErrors(filtered);
      }

      function renderErrors(groups) {
        UI.errorList.innerHTML = "";
        if (state.currentGroup) {
          const exists = groups.find((g) => g.id === state.currentGroup.id);
          if (!exists) {
            UI.contextView.innerHTML =
              '<div class="text-center p-6 border-2 border-dashed border-slate-800 rounded-xl"><p class="text-lg mb-2">Chưa chọn lỗi nào</p><p class="text-sm opacity-60">Chọn một mục từ danh sách bên trái</p></div>';
            UI.contextNav.classList.add("hidden");
            state.currentGroup = null;
          }
        }
        if (groups.length === 0) {
          UI.errorList.innerHTML =
            '<div class="p-10 text-center text-slate-600 flex flex-col items-center"><svg class="w-16 h-16 mb-4 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="text-lg font-medium">Tuyệt vời!</p><p class="text-sm mt-1">Không tìm thấy lỗi nào.</p></div>';
          return;
        }
        const template = document.getElementById("error-item-template");
        groups.forEach((group) => {
          const clone = template.content.cloneNode(true);
          clone.querySelector(".error-word").innerText = group.word;
          clone.querySelector(".error-reason").innerText = group.type;
          clone.querySelector(".error-count").innerText = group.contexts.length;
          const style = getErrorHighlights(group.type);
          clone.querySelector(".status-dot").classList.add(style.dot);
          const btn = clone.querySelector(".select-btn");
          if (state.currentGroup && state.currentGroup.id === group.id) {
            btn.classList.add(
              "bg-blue-900/30",
              "border-blue-700/50",
              "ring-1",
              "ring-blue-500/50"
            );
            btn.classList.remove("border-transparent", "border-r");
          }
          btn.onclick = () => {
            selectGroup(group, btn);
            copyToClipboard(group.word);
          };
          clone.querySelector(".ignore-btn").onclick = (e) => {
            e.stopPropagation();
            quickIgnore(group.word);
          };
          UI.errorList.appendChild(clone);
        });
      }

      function selectGroup(group, btnElement) {
        state.currentGroup = group;
        state.currentInstanceIndex = 0;
        document.querySelectorAll("#error-list .select-btn").forEach((b) => {
          b.classList.remove(
            "bg-blue-900/30",
            "border-blue-700/50",
            "ring-1",
            "ring-blue-500/50"
          );
          b.classList.add("border-transparent", "border-r");
        });
        if (btnElement) {
          btnElement.classList.add(
            "bg-blue-900/30",
            "border-blue-700/50",
            "ring-1",
            "ring-blue-500/50"
          );
          btnElement.classList.remove("border-transparent", "border-r");
        }
        if (group.contexts.length > 1) UI.contextNav.classList.remove("hidden");
        else UI.contextNav.classList.add("hidden");
        updateContextView();
      }

      function updateContextView() {
        if (!state.currentGroup) return;
        const ctx = state.currentGroup.contexts[state.currentInstanceIndex];
        UI.navIndicator.innerText = `${state.currentInstanceIndex + 1}/${
          state.currentGroup.contexts.length
        }`;
        UI.btnPrev.disabled = state.currentInstanceIndex === 0;
        UI.btnNext.disabled =
          state.currentInstanceIndex === state.currentGroup.contexts.length - 1;
        const suggestions = findSuggestions(state.currentGroup.word);
        const suggHTML =
          suggestions.length > 0
            ? `<div class="mt-4 flex flex-wrap justify-center gap-2"><span class="text-sm text-slate-400 mr-1 self-center">Gợi ý:</span>${suggestions
                .map(
                  (s) =>
                    `<span class="bg-green-900/30 text-green-400 border border-green-700/50 px-2 py-1 rounded text-sm cursor-pointer hover:bg-green-800/50" onclick="copyToClipboard('${s}')">${s}</span>`
                )
                .join("")}</div>`
            : "";
        const style = getErrorHighlights(state.currentGroup.type);
        const wiktionary = `<a href="https://vi.wiktionary.org/wiki/${state.currentGroup.word}" target="_blank" class="ml-1 inline-flex items-center text-blue-400 hover:text-blue-300 transition-colors" title="Tra cứu Wiktionary"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></a>`;
        UI.contextView.innerHTML = `<div class="max-w-2xl text-center w-full animate-fadeIn"><div class="flex items-center justify-center gap-2 mb-6"><span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest bg-slate-800 px-2 py-1 rounded">Ngữ cảnh ${
          state.currentInstanceIndex + 1
        } / ${
          state.currentGroup.contexts.length
        }</span></div><div class="bg-slate-900 p-8 rounded-xl border border-slate-800 shadow-inner relative"><div class="text-xl leading-loose text-slate-300 font-serif">${escapeHtml(
          ctx.prefix
        )}<span class="${style.bg} ${
          style.text
        } px-1 py-0.5 rounded border-b-2 ${
          style.border
        } font-bold mx-0.5 shadow-[0_0_15px_rgba(0,0,0,0.2)]">${escapeHtml(
          ctx.target
        )} ${wiktionary}</span>${escapeHtml(
          ctx.suffix
        )}</div></div><div class="mt-8 flex flex-col items-center justify-center gap-4"><div class="px-5 py-3 bg-slate-800 text-slate-300 rounded-lg text-sm border border-slate-700 shadow-lg flex items-center gap-3"><span class="w-3 h-3 rounded-full ${
          style.dot
        } shadow-[0_0_8px_currentColor]"></span><span class="text-slate-200 font-medium">${
          state.currentGroup.type
        }</span></div>${suggHTML}</div></div>`;
      }

      function quickIgnore(word) {
        let targetIndex = -1;
        if (state.currentGroup)
          targetIndex = state.currentFilteredErrors.findIndex(
            (g) => g.id === state.currentGroup.id
          );
        const sep = UI.whitelistInput.value.trim() ? ", " : "";
        UI.whitelistInput.value += sep + word;
        saveWhitelist();
        filterAndRenderErrors();
        if (targetIndex !== -1 && state.currentFilteredErrors.length > 0) {
          if (targetIndex >= state.currentFilteredErrors.length)
            targetIndex = state.currentFilteredErrors.length - 1;
          const nextGroup = state.currentFilteredErrors[targetIndex];
          selectGroup(nextGroup, null);
          setTimeout(() => {
            const btns = document.querySelectorAll("#error-list .select-btn");
            if (btns[targetIndex]) {
              btns[targetIndex].scrollIntoView({
                block: "nearest",
                behavior: "smooth",
              });
              btns[targetIndex].classList.add(
                "bg-blue-900/30",
                "border-blue-700/50",
                "ring-1",
                "ring-blue-500/50"
              );
              btns[targetIndex].classList.remove(
                "border-transparent",
                "border-r"
              );
            }
          }, 0);
        } else if (state.currentFilteredErrors.length === 0) {
          UI.contextView.innerHTML =
            '<div class="text-center p-6 border-2 border-dashed border-slate-800 rounded-xl"><p class="text-lg mb-2">Tuyệt vời!</p><p class="text-sm opacity-60">Đã xử lý hết lỗi.</p></div>';
          UI.contextNav.classList.add("hidden");
          state.currentGroup = null;
        }
      }

      function navigateErrors(direction) {
        let nextIndex = 0;
        if (state.currentGroup) {
          const currentIndex = state.currentFilteredErrors.findIndex(
            (g) => g.id === state.currentGroup.id
          );
          if (currentIndex !== -1) nextIndex = currentIndex + direction;
        }
        if (nextIndex < 0) nextIndex = 0;
        if (nextIndex >= state.currentFilteredErrors.length)
          nextIndex = state.currentFilteredErrors.length - 1;
        const nextGroup = state.currentFilteredErrors[nextIndex];
        if (nextGroup) {
          selectGroup(nextGroup, null);
          const btns = document.querySelectorAll("#error-list .select-btn");
          if (btns[nextIndex]) {
            btns[nextIndex].scrollIntoView({
              block: "nearest",
              behavior: "smooth",
            });
            btns.forEach((b) => {
              b.classList.remove(
                "bg-blue-900/30",
                "border-blue-700/50",
                "ring-1",
                "ring-blue-500/50"
              );
              b.classList.add("border-transparent", "border-r");
            });
            btns[nextIndex].classList.add(
              "bg-blue-900/30",
              "border-blue-700/50",
              "ring-1",
              "ring-blue-500/50"
            );
            btns[nextIndex].classList.remove("border-transparent", "border-r");
          }
        }
      }

      function resetApp() {
        UI.resultsSection.classList.add("hidden");
        UI.resetBtn.classList.add("hidden");
        UI.exportBtn.classList.add("hidden");
        UI.uploadSection.classList.remove("hidden");
        UI.fileInput.value = "";
        state = {
          ...state,
          allDetectedErrors: [],
          currentFilteredErrors: [],
          currentGroup: null,
          currentInstanceIndex: 0,
          currentBookTitle: "",
          loadedTextContent: [],
          currentCoverUrl: null,
        };
        if (state.currentCoverUrl) URL.revokeObjectURL(state.currentCoverUrl);
        UI.statTotalWords.innerText = "0";
        UI.statErrors.innerText = "0";
        UI.statGroups.innerText = "0";
        UI.errorList.innerHTML = "";
        UI.contextView.innerHTML =
          '<div class="text-center p-6 border-2 border-dashed border-slate-800 rounded-xl"><p class="text-lg mb-2">Chưa chọn lỗi nào</p><p class="text-sm opacity-60">Chọn một mục từ danh sách bên trái</p></div>';
        UI.contextNav.classList.add("hidden");
        UI.metaTitle.innerText = "";
        UI.metaAuthor.innerText = "";
        UI.metaCover.src = "";
        UI.metaCover.classList.add("hidden");
        UI.metaCoverPlaceholder.classList.remove("hidden");
      }

      function performExport(type) {
        const filteredErrors = state.currentFilteredErrors;
        if (filteredErrors.length === 0) {
          alert("Không có lỗi nào để xuất!");
          UI.exportModal.classList.add("hidden");
          return;
        }
        let content = "";
        if (type === "vctve")
          content = filteredErrors.map((g) => `${g.word} ==>`).join("\n\n");
        else content = filteredErrors.map((g) => g.word).join("\n");
        const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        let fileName = state.currentBookTitle
          ? `loi-${state.currentBookTitle
              .replace(/[<>:"/\\|?*\x00-\x1F]/g, "")
              .trim()}.txt`
          : "loi-khong-ro-ten.txt";
        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        UI.exportModal.classList.add("hidden");
      }

      function setupEventListeners() {
        UI.uploadSection.addEventListener("click", () => UI.fileInput.click());
        UI.uploadSection.addEventListener("dragover", (e) => {
          e.preventDefault();
          UI.uploadSection.classList.add("border-blue-500", "bg-slate-800");
        });
        UI.uploadSection.addEventListener("dragleave", () =>
          UI.uploadSection.classList.remove("border-blue-500", "bg-slate-800")
        );
        UI.uploadSection.addEventListener("drop", (e) => {
          e.preventDefault();
          UI.uploadSection.classList.remove("border-blue-500", "bg-slate-800");
          if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        UI.fileInput.addEventListener("change", (e) => {
          if (e.target.files.length) handleFile(e.target.files[0]);
        });
        UI.resetBtn.addEventListener("click", resetApp);
        UI.exportBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          UI.exportModal.classList.remove("hidden");
        });
        document
          .getElementById("close-export-btn")
          .addEventListener("click", () =>
            UI.exportModal.classList.add("hidden")
          );
        document
          .getElementById("export-vctve-btn")
          .addEventListener("click", () => performExport("vctve"));
        document
          .getElementById("export-normal-btn")
          .addEventListener("click", () => performExport("normal"));
        UI.settingsBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          UI.settingsModal.classList.remove("hidden");
        });
        UI.closeSettingsBtn.addEventListener("click", () =>
          UI.settingsModal.classList.add("hidden")
        );
        UI.helpBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          UI.helpModal.classList.remove("hidden");
        });
        UI.closeHelpBtn.addEventListener("click", () =>
          UI.helpModal.classList.add("hidden")
        );
        document
          .getElementById("sort-select")
          .addEventListener("change", (e) => {
            state.sortMode = e.target.value;
            filterAndRenderErrors();
          });
        document.addEventListener("click", (e) => {
          if (
            !UI.settingsModal.classList.contains("hidden") &&
            !UI.settingsModal.contains(e.target) &&
            !UI.settingsBtn.contains(e.target)
          )
            UI.settingsModal.classList.add("hidden");
          if (
            !UI.helpModal.classList.contains("hidden") &&
            e.target === UI.helpModal
          )
            UI.helpModal.classList.add("hidden");
          if (
            !UI.exportModal.classList.contains("hidden") &&
            e.target === UI.exportModal
          )
            UI.exportModal.classList.add("hidden");
        });
        ["set-dict", "set-case", "set-tone", "set-struct"].forEach((id) =>
          document.getElementById(id).addEventListener("change", saveSettings)
        );
        UI.whitelistInput.addEventListener("input", () => {
          saveWhitelist();
          filterAndRenderErrors();
        });
        UI.engFilterCheckbox.addEventListener("change", (e) => {
          state.isEngFilterEnabled = e.target.checked;
          filterAndRenderErrors();
        });
        document.addEventListener("keydown", (e) => {
          if (
            document.activeElement === UI.whitelistInput ||
            !UI.settingsModal.classList.contains("hidden") ||
            !UI.helpModal.classList.contains("hidden") ||
            !UI.exportModal.classList.contains("hidden")
          )
            return;
          if (state.currentFilteredErrors.length === 0) return;
          if (e.key === "ArrowDown") {
            e.preventDefault();
            navigateErrors(1);
          } else if (e.key === "ArrowUp") {
            e.preventDefault();
            navigateErrors(-1);
          } else if (e.key === "Delete" || e.key.toLowerCase() === "i") {
            if (state.currentGroup) {
              e.preventDefault();
              quickIgnore(state.currentGroup.word);
            }
          }
        });
        UI.btnPrev.addEventListener("click", () => {
          if (state.currentGroup && state.currentInstanceIndex > 0) {
            state.currentInstanceIndex--;
            updateContextView();
          }
        });
        UI.btnNext.addEventListener("click", () => {
          if (
            state.currentGroup &&
            state.currentInstanceIndex < state.currentGroup.contexts.length - 1
          ) {
            state.currentInstanceIndex++;
            updateContextView();
          }
        });
      }

      function init() {
        loadDictionaries();
        loadWhitelist();
        loadSettings();
        setupEventListeners();
      }
      init();
    </script>
  </body>
</html>
