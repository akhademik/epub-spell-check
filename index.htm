<!DOCTYPE html>
<html lang="vi" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vietnamese EPUB Spell Checker</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z' /%3E%3C/svg%3E">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"
      defer
    ></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              slate: {
                850: "#1e293b",
                900: "#0f172a",
                950: "#020617",
              },
            },
            fontFamily: {
              sans: ['"Noto Sans"', "sans-serif"],
              serif: ['"Noto Serif"', "serif"],
            },
          },
        },
      };
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Serif:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans", sans-serif;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>
  </head>
  <body
    class="bg-slate-950 text-slate-200 min-h-screen flex flex-col transition-colors duration-300"
  >
    <!-- Header -->
    <header
      class="bg-slate-900 border-b border-slate-800 sticky top-0 z-20 shadow-md"
    >
      <div
        class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between"
      >
        <div class="flex items-center gap-3">
          <div
            class="bg-blue-600 text-white p-2 rounded-lg shadow-lg shadow-blue-900/20"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              />
            </svg>
          </div>
          <div>
            <h1 class="text-xl font-bold text-slate-100 tracking-tight">
              Soát Lỗi Chính Tả EPUB
            </h1>
                        <div class="text-xs text-slate-500 font-medium">v1.2 - 27/12/2025</div>
          </div>
        </div>

        <div class="flex items-center gap-4">
          <!-- Reset Button -->
          <button
            id="reset-btn"
            class="hidden px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-medium transition-colors shadow-lg shadow-blue-900/20 flex items-center gap-2"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              />
            </svg>
            <span class="hidden sm:inline">Kiểm tra tệp khác</span>
          </button>

          <div
            id="dict-status"
            class="hidden md:flex items-center gap-2 text-xs px-3 py-1.5 rounded-full bg-slate-800 border border-slate-700"
          >
            <div
              class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"
              id="dict-dot"
            ></div>
            <span id="dict-text" class="text-slate-400"
              >Đang tải từ điển...</span
            >
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main
      class="flex-grow max-w-6xl mx-auto px-4 py-8 w-full flex flex-col gap-6"
    >
      <!-- Upload Section -->
      <div
        id="upload-section"
        class="bg-slate-900 rounded-2xl shadow-xl border-2 border-dashed border-slate-800 p-12 text-center transition-all hover:border-blue-500/50 hover:bg-slate-800/50 group cursor-pointer relative overflow-hidden"
      >
        <input type="file" id="file-input" accept=".epub" class="hidden" />

        <div
          class="absolute inset-0 bg-gradient-to-br from-blue-500/5 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity"
        ></div>

        <div
          class="relative z-10 flex flex-col items-center justify-center gap-6 pointer-events-none"
        >
          <div
            class="w-20 h-20 bg-slate-800 text-blue-500 rounded-full flex items-center justify-center group-hover:scale-110 group-hover:bg-slate-700 group-hover:text-blue-400 transition-all duration-300 shadow-lg shadow-black/20"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-10 w-10"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
              />
            </svg>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-slate-200">Tải lên sách EPUB</h2>
            <p class="text-slate-400 mt-2 text-lg">
              Kéo thả hoặc nhấp để chọn tệp
            </p>
          </div>
          <div class="flex gap-4 mt-2">
            <span
              class="px-3 py-1 rounded bg-slate-800 border border-slate-700 text-xs text-slate-500"
              >.epub only</span
            >
            <span
              class="px-3 py-1 rounded bg-slate-800 border border-slate-700 text-xs text-slate-500"
              >Xử lý ngoại tuyến</span
            >
          </div>
        </div>
      </div>

      <!-- Processing UI -->
      <div
        id="processing-ui"
        class="hidden bg-slate-900 p-8 rounded-2xl shadow-xl border border-slate-800 max-w-2xl mx-auto w-full"
      >
        <div class="flex justify-between items-end mb-4">
          <div>
            <h3 class="text-lg font-semibold text-white mb-1">
              Đang phân tích
            </h3>
            <div id="status-text" class="text-slate-400 text-sm">
              Đang khởi tạo...
            </div>
          </div>
          <span id="progress-percent" class="text-3xl font-bold text-blue-500"
            >0%</span
          >
        </div>
        <div
          class="w-full bg-slate-800 rounded-full h-3 overflow-hidden box-border border border-slate-700/50"
        >
          <div
            id="progress-bar"
            class="bg-gradient-to-r from-blue-600 to-indigo-600 h-full rounded-full transition-all duration-300 shadow-[0_0_10px_rgba(37,99,235,0.5)]"
            style="width: 0%"
          ></div>
        </div>
      </div>

      <!-- Results Section -->
      <div id="results-section" class="hidden flex flex-col gap-6">
        <!-- Book Info -->
        <div
          class="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-lg flex items-center gap-5 relative overflow-hidden min-h-[140px]"
        >
          <div
            class="absolute right-0 top-0 p-6 opacity-10 pointer-events-none"
          >
            <svg
              class="w-40 h-40 text-white"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1"
                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
              />
            </svg>
          </div>

          <!-- Cover Image Container -->
          <div
            class="w-20 h-28 bg-slate-800 rounded-lg flex-shrink-0 border border-slate-700 overflow-hidden relative shadow-md"
          >
            <img
              id="meta-cover"
              class="w-full h-full object-cover hidden"
              alt="Bìa sách"
            />
            <div
              id="meta-cover-placeholder"
              class="w-full h-full flex items-center justify-center text-slate-600"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-8 w-8"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
                />
              </svg>
            </div>
          </div>

          <div class="relative z-10">
            <div
              class="text-xs text-blue-400 font-bold uppercase tracking-wider mb-1"
            >
              Đang kiểm tra
            </div>
            <h2
              id="meta-title"
              class="text-2xl font-bold text-white leading-tight"
            >
              Đang tải...
            </h2>
            <p
              id="meta-author"
              class="text-slate-400 mt-1 font-serif italic text-lg"
            >
              Đang tải...
            </p>
          </div>
        </div>

        <!-- Whitelist Input -->
        <div
          class="bg-slate-900 p-5 rounded-xl border border-slate-800 shadow-lg"
        >
          <div class="flex items-center justify-between mb-2">
            <label for="ignore-foreign-words-checkbox" class="flex items-center gap-2 text-sm font-bold text-slate-300">
              <input type="checkbox" id="ignore-foreign-words-checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
              Bỏ qua tên riêng/từ nước ngoài
            </label>
          </div>
          <div class="flex items-center justify-between mb-2">
            <label
              for="whitelist-input"
              class="flex items-center gap-2 text-sm font-bold text-slate-300"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4 text-green-500"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              Thêm từ bỏ qua (Whitelist - Đã lưu)
            </label>
            <span class="text-xs text-slate-500"
              >Tự động cập nhật & lưu kết quả</span
            >
          </div>
          <textarea
            id="whitelist-input"
            rows="2"
            class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-slate-200 text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500 placeholder-slate-600 transition-colors"
            placeholder="Nhập các từ muốn bỏ qua, cách nhau bằng dấu phẩy, khoảng trắng hoặc xuống dòng (Ví dụ: tên nhân vật, địa danh lạ...)"
          ></textarea>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div
            class="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-lg relative overflow-hidden"
          >
            <div class="absolute right-0 top-0 p-4 opacity-5">
              <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 20 20">
                <path
                  d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.968 7.968 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"
                />
              </svg>
            </div>
            <div
              class="text-slate-500 text-sm font-medium mb-1 uppercase tracking-wider"
            >
              Từ đã quét
            </div>
            <div
              id="stat-total-words"
              class="text-3xl font-bold text-slate-100"
            >
              0
            </div>
          </div>
          <div
            class="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-lg relative overflow-hidden group"
          >
            <div class="absolute right-0 top-0 p-4 opacity-5 text-red-500">
              <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <div
              class="text-red-400 text-sm font-medium mb-1 uppercase tracking-wider"
            >
              Lỗi phát hiện
            </div>
            <div
              id="stat-errors"
              class="text-3xl font-bold text-red-500 group-hover:scale-105 transition-transform origin-left"
            >
              0
            </div>
          </div>
          <div
            class="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-lg relative overflow-hidden"
          >
            <div class="absolute right-0 top-0 p-4 opacity-5 text-blue-500">
              <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 20 20">
                <path
                  d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"
                />
              </svg>
            </div>
            <div
              class="text-blue-400 text-sm font-medium mb-1 uppercase tracking-wider"
            >
              Nhóm lỗi
            </div>
            <div id="stat-groups" class="text-3xl font-bold text-blue-400">
              0
            </div>
          </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-6 h-[600px] lg:h-[700px]">
          <!-- Error List Sidebar -->
          <div
            class="w-full lg:w-1/3 flex flex-col bg-slate-900 rounded-2xl border border-slate-800 shadow-xl overflow-hidden"
          >
            <div
              class="p-4 border-b border-slate-800 bg-slate-900/50 backdrop-blur font-semibold text-slate-300 flex justify-between items-center"
            >
              <span class="flex items-center gap-2">
                <svg
                  class="w-4 h-4 text-slate-500"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6h16M4 10h16M4 14h16M4 18h16"
                  />
                </svg>
                Danh sách lỗi
              </span>
              <div
                class="text-xs px-2 py-1 rounded bg-slate-800 text-slate-500 border border-slate-700"
              >
                Sắp xếp theo tần suất
              </div>
            </div>
            <div
              id="error-list"
              class="flex-1 overflow-y-auto p-2 space-y-1 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent"
            >
              <!-- Items will be injected here -->
            </div>
          </div>

          <!-- Context Preview -->
          <div
            class="w-full lg:w-2/3 flex flex-col bg-slate-900 rounded-2xl border border-slate-800 shadow-xl overflow-hidden"
          >
            <div
              class="p-4 border-b border-slate-800 bg-slate-900/50 backdrop-blur font-semibold text-slate-300 flex justify-between items-center"
            >
              <span class="flex items-center gap-2">
                <svg
                  class="w-4 h-4 text-slate-500"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                  />
                </svg>
                Ngữ cảnh
              </span>
              <div
                id="context-nav"
                class="hidden flex items-center gap-2 text-sm bg-slate-800 rounded-lg p-1 border border-slate-700"
              >
                <button
                  id="btn-prev"
                  class="p-1.5 hover:bg-slate-700 rounded-md text-slate-400 hover:text-white disabled:opacity-30 transition-colors"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </button>
                <span
                  id="nav-indicator"
                  class="font-mono text-slate-300 min-w-[3rem] text-center text-xs"
                  >1/1</span
                >
                <button
                  id="btn-next"
                  class="p-1.5 hover:bg-slate-700 rounded-md text-slate-400 hover:text-white disabled:opacity-30 transition-colors"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </button>
              </div>
            </div>
            <div
              id="context-view"
              class="flex-1 p-8 overflow-y-auto flex flex-col items-center justify-center text-slate-500 bg-slate-950/50 relative"
            >
              <div
                class="text-center p-6 border-2 border-dashed border-slate-800 rounded-xl"
              >
                <p class="text-lg mb-2">Chưa chọn lỗi nào</p>
                <p class="text-sm opacity-60">
                  Chọn một mục từ danh sách bên trái
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer
      class="mt-auto py-6 text-center text-slate-600 text-sm border-t border-slate-900 bg-slate-950"
    >
      <p>
        <a
          href="https://github.com/duyet/vietnamese-wordlist"
          target="_blank"
          class="hover:text-blue-400 underline transition-colors"
          >Sử dụng từ điển Viet74K</a
        >
      </p>
    </footer>

    <!-- Templates -->
    <template id="error-item-template">
      <div
        class="w-full flex items-stretch rounded-lg hover:bg-slate-800 group transition-all mb-1 bg-slate-900 border border-transparent hover:border-slate-700"
      >
        <button
          class="select-btn flex-grow text-left px-4 py-3 flex items-center justify-between focus:outline-none rounded-l-lg border-r border-slate-800/50 group-hover:border-slate-700"
        >
          <div class="overflow-hidden">
            <div class="flex items-center gap-2">
              <span
                class="font-bold text-red-400 error-word text-lg truncate font-serif"
              ></span>
              <span
                class="bg-red-500/10 text-red-400 border border-red-500/20 text-[10px] font-bold px-2 py-0.5 rounded-full error-count flex-shrink-0"
              ></span>
            </div>
            <div
              class="text-xs text-slate-500 mt-1 error-reason truncate"
            ></div>
          </div>
        </button>
        <button
          class="ignore-btn px-3 flex items-center justify-center text-slate-600 hover:text-green-400 hover:bg-slate-800/50 rounded-r-lg transition-colors"
          title="Bỏ qua (Whitelist)"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"
            />
          </svg>
        </button>
      </div>
    </template>

    <script>
      // --- CONFIGURATION ---

      let IGNORED_WORDS = new Set();
      let NAMES_WHITELIST = new Set();
      let LOCAL_WHITELIST = new Set();

      // DOM Elements
      const fileInput = document.getElementById("file-input");
      const uploadSection = document.getElementById("upload-section");
      const processingUi = document.getElementById("processing-ui");
      const progressBar = document.getElementById("progress-bar");
      const progressPercent = document.getElementById("progress-percent");
      const statusText = document.getElementById("status-text");
      const resultsSection = document.getElementById("results-section");
      const errorList = document.getElementById("error-list");
      const contextView = document.getElementById("context-view");

      // Metadata & Cover Elements
      const metaTitle = document.getElementById("meta-title");
      const metaAuthor = document.getElementById("meta-author");
      const metaCover = document.getElementById("meta-cover");
      const metaCoverPlaceholder = document.getElementById(
        "meta-cover-placeholder"
      );

      // New Element: Whitelist Input
      const whitelistInput = document.getElementById("whitelist-input");
      const ignoreForeignWordsCheckbox = document.getElementById("ignore-foreign-words-checkbox");

      // New Element: Reset Button
      const resetBtn = document.getElementById("reset-btn");

      // Dictionary Status Elements
      const dictStatus = document.getElementById("dict-status");
      const dictDot = document.getElementById("dict-dot");
      const dictText = document.getElementById("dict-text");

      // Navigation Elements
      const contextNav = document.getElementById("context-nav");
      const btnPrev = document.getElementById("btn-prev");
      const btnNext = document.getElementById("btn-next");
      const navIndicator = document.getElementById("nav-indicator");

      // Stats Elements
      const statTotalWords = document.getElementById("stat-total-words");
      const statErrors = document.getElementById("stat-errors");
      const statGroups = document.getElementById("stat-groups");

      // State
      let allDetectedErrors = []; // Store raw results before filtering
      let currentGroup = null;
      let currentInstanceIndex = 0;
      let validSyllables = new Set(); // Stores our dictionary
      let isDictLoaded = false;
      let currentCoverUrl = null; // Store cover blob URL to revoke later
      let currentActiveButton = null; // Store reference to the active error item button

      // --- PERSISTENCE ---
      const STORAGE_KEY = "vn_spell_whitelist";

      function loadWhitelist() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          whitelistInput.value = saved;
        }
      }

      function saveWhitelist() {
        localStorage.setItem(STORAGE_KEY, whitelistInput.value);
      }

      // --- DICTIONARY AND WHITELIST LOADING ---
      const DICT_URL = "vn-dict.txt";
      const WHITELIST_URL = "whitelist.txt";
      const NAMES_URL = "names.txt";

      async function loadDictionary() {
        try {
          dictStatus.classList.remove("hidden");
          dictText.innerText = "Đang tải từ điển cục bộ...";

          const response = await fetch(DICT_URL);
          if (!response.ok) throw new Error(`Fetch failed for ${DICT_URL}`);

          const text = await response.text();
          const lines = text.split("\n");
          lines.forEach((line) => {
            const cleanLine = line.trim().toLowerCase().normalize("NFC");
            if (cleanLine) {
              const parts = cleanLine.split(/\s+/);
              parts.forEach((p) => validSyllables.add(p));
            }
          });

          isDictLoaded = true;
          dictDot.classList.remove("bg-yellow-500", "animate-pulse");
          dictDot.classList.add("bg-green-500");
          dictText.innerText = `Đã tải từ điển (${validSyllables.size.toLocaleString()} từ)`;
          console.log(`Đã tải từ điển: ${validSyllables.size} âm tiết`);
        } catch (err) {
          console.warn("Tải từ điển thất bại, sử dụng quy tắc dự phòng:", err);
          dictDot.classList.remove("bg-yellow-500", "animate-pulse");
          dictDot.classList.add("bg-red-500");
          dictText.innerText = "Lỗi tải từ điển (Dùng quy tắc cũ)";
        }
      }

      async function loadIgnoreLists() {
        const urls = [
          { url: WHITELIST_URL, set: LOCAL_WHITELIST },
          { url: NAMES_URL, set: NAMES_WHITELIST },
        ];

        for (const { url, set } of urls) {
          try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Fetch failed for ${url}`);
            const text = await response.text();
            const lines = text.split("\n");
            let count = 0;
            lines.forEach((line) => {
              const cleanLine = line.trim().toLowerCase().normalize("NFC");
              if (cleanLine) {
                set.add(cleanLine);
                count++;
              }
            });
            console.log(`Đã tải ${count} từ từ ${url}`);
          } catch (err) {
            console.warn(`Tải danh sách bỏ qua (${url}) thất bại:`, err);
          }
        }
      }
      
      function updateIgnoredWords() {
        IGNORED_WORDS = new Set();
        const rawInput = whitelistInput.value;
        if (rawInput) {
          const tokens = rawInput
            .split(/[\n,\t]+/)
            .map((t) => t.trim().toLowerCase().normalize("NFC"))
            .filter((t) => t.length > 0);
          tokens.forEach((t) => IGNORED_WORDS.add(t));
        }

        LOCAL_WHITELIST.forEach(word => IGNORED_WORDS.add(word)); // Always add whitelist.txt
        if (ignoreForeignWordsCheckbox.checked) {
          NAMES_WHITELIST.forEach(word => IGNORED_WORDS.add(word)); // Only add names.txt if checked
        }
        
        filterAndRenderErrors();
      }

      // Trigger loads on startup
      loadWhitelist(); // for localStorage
      Promise.all([loadDictionary(), loadIgnoreLists()]).then(() => {
        console.log("Hoàn tất tải từ điển và danh sách bỏ qua.");
        updateIgnoredWords();
      });

      // Setup Event Listeners
      uploadSection.addEventListener("click", () => fileInput.click());
      uploadSection.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadSection.classList.add("border-blue-500", "bg-slate-800");
      });
      uploadSection.addEventListener("dragleave", () => {
        uploadSection.classList.remove("border-blue-500", "bg-slate-800");
      });
      uploadSection.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadSection.classList.remove("border-blue-500", "bg-slate-800");
        if (e.dataTransfer.files.length) {
          handleFile(e.dataTransfer.files[0]);
        }
      });
      fileInput.addEventListener("change", (e) => {
        if (e.target.files.length) handleFile(e.target.files[0]);
      });

      resetBtn.addEventListener("click", resetApp);

      // Dynamic Whitelist Listener with Persistence
      whitelistInput.addEventListener("input", () => {
        saveWhitelist();
        updateIgnoredWords();
      });
      
      ignoreForeignWordsCheckbox.addEventListener("change", updateIgnoredWords);

      // Main Logic
      async function handleFile(file) {
        if (!file.name.endsWith(".epub")) {
          alert("Vui lòng chọn file .epub");
          return;
        }

        uploadSection.classList.add("hidden");
        resultsSection.classList.add("hidden");
        processingUi.classList.remove("hidden");
        errorList.innerHTML = "";
        // Don't clear whitelistInput.value here to keep persistence
        contextView.innerHTML =
          '<div class="text-center p-6 border-2 border-dashed border-slate-800 rounded-xl"><p class="text-lg mb-2">Chưa chọn lỗi nào</p><p class="text-sm opacity-60">Chọn một mục từ danh sách bên trái</p></div>';
        contextNav.classList.add("hidden");
        metaTitle.innerText = "Đang tải...";
        metaAuthor.innerText = "Đang tải...";

        // Reset cover
        metaCover.src = "";
        metaCover.classList.add("hidden");
        metaCoverPlaceholder.classList.remove("hidden");
        if (currentCoverUrl) {
          URL.revokeObjectURL(currentCoverUrl);
          currentCoverUrl = null;
        }

        try {
          updateProgress(10, "Đang giải nén tệp...");
          const zip = await JSZip.loadAsync(file);

          updateProgress(30, "Đang đọc cấu trúc sách...");
          const { fullTextBlocks, title, author, coverUrl } = await parseEpub(
            zip
          );

          // Update UI with Metadata
          metaTitle.innerText = title;
          metaAuthor.innerText = author;

          if (coverUrl) {
            currentCoverUrl = coverUrl;
            metaCover.src = coverUrl;
            metaCover.classList.remove("hidden");
            metaCoverPlaceholder.classList.add("hidden");
          }

          updateProgress(
            60,
            "Đang phân tích với " + (isDictLoaded ? "từ điển..." : "quy tắc...")
          );

          requestAnimationFrame(() => {
            setTimeout(() => {
              analyzeText(fullTextBlocks);
              processingUi.classList.add("hidden");
              resultsSection.classList.remove("hidden");
              resetBtn.classList.remove("hidden");
            }, 100);
          });
        } catch (err) {
          console.error(err);
          alert("Có lỗi xảy ra: " + err.message);
          processingUi.classList.add("hidden");
          uploadSection.classList.remove("hidden");
        }
      }

      function resetApp() {
        resultsSection.classList.add("hidden");
        resetBtn.classList.add("hidden");
        uploadSection.classList.remove("hidden");
        fileInput.value = "";

        statTotalWords.innerText = "0";
        statErrors.innerText = "0";
        statGroups.innerText = "0";
        errorList.innerHTML = "";
        contextView.innerHTML =
          '<div class="text-center p-6 border-2 border-dashed border-slate-800 rounded-xl"><p class="text-lg mb-2">Chưa chọn lỗi nào</p><p class="text-sm opacity-60">Chọn một mục từ danh sách bên trái</p></div>';
        contextNav.classList.add("hidden");
        metaTitle.innerText = "";
        metaAuthor.innerText = "";

        // Reset cover
        metaCover.src = "";
        metaCover.classList.add("hidden");
        metaCoverPlaceholder.classList.remove("hidden");
        if (currentCoverUrl) {
          URL.revokeObjectURL(currentCoverUrl);
          currentCoverUrl = null;
        }

        allDetectedErrors = [];
        currentGroup = null;
        currentInstanceIndex = 0;
        currentActiveButton = null;
      }

      function updateProgress(percent, text) {
        progressBar.style.width = percent + "%";
        progressPercent.innerText = percent + "%";
        statusText.innerText = text;
      }

      async function parseEpub(zip) {
        const containerData = await zip
          .file("META-INF/container.xml")
          .async("string");
        const parser = new DOMParser();
        const containerXml = parser.parseFromString(
          containerData,
          "application/xml"
        );
        const rootPath = containerXml
          .querySelector("rootfile")
          .getAttribute("full-path");

        const opfData = await zip.file(rootPath).async("string");
        const opfXml = parser.parseFromString(opfData, "application/xml");

        const opfDir = rootPath.substring(0, rootPath.lastIndexOf("/"));
        const resolvePath = (p) => (opfDir ? opfDir + "/" + p : p);

        // Extract Metadata
        const title =
          opfXml.getElementsByTagName("dc:title")[0]?.textContent ||
          opfXml.querySelector("title")?.textContent ||
          "Không rõ tên sách";

        const author =
          opfXml.getElementsByTagName("dc:creator")[0]?.textContent ||
          opfXml.querySelector("creator")?.textContent ||
          "Không rõ tác giả";

        // Extract Cover
        let coverUrl = null;
        try {
          let coverHref = null;
          // Method 1: meta name="cover"
          const coverMeta = opfXml.querySelector('meta[name="cover"]');
          if (coverMeta) {
            const coverId = coverMeta.getAttribute("content");
            const coverItem = opfXml.querySelector(
              `manifest item[id="${coverId}"]`
            );
            if (coverItem) coverHref = coverItem.getAttribute("href");
          }
          // Method 2: item properties="cover-image"
          if (!coverHref) {
            const coverItem = opfXml.querySelector(
              'manifest item[properties*="cover-image"]'
            );
            if (coverItem) coverHref = coverItem.getAttribute("href");
          }

          if (coverHref) {
            const fullCoverPath = resolvePath(coverHref);
            const coverFile = zip.file(fullCoverPath);
            if (coverFile) {
              const coverBlob = await coverFile.async("blob");
              coverUrl = URL.createObjectURL(coverBlob);
            }
          }
        } catch (e) {
          console.warn("Không thể trích xuất bìa sách:", e);
        }

        const spine = Array.from(opfXml.querySelectorAll("spine itemref")).map(
          (ref) => ref.getAttribute("idref")
        );
        const manifest = {};
        Array.from(opfXml.querySelectorAll("manifest item")).forEach((item) => {
          manifest[item.getAttribute("id")] = item.getAttribute("href");
        });

        let fullTextBlocks = [];
        let totalItems = spine.length;

        for (let i = 0; i < totalItems; i++) {
          const id = spine[i];
          const href = manifest[id];
          const fullPath = resolvePath(href);

          if (zip.file(fullPath)) {
            const htmlContent = await zip.file(fullPath).async("string");
            const doc = parser.parseFromString(htmlContent, "text/html");
            const paragraphs = Array.from(
              doc.querySelectorAll("p, h1, h2, h3, h4, h5, h6, li, div")
            )
              .map((el) => el.textContent.trim())
              .filter((text) => text.length > 0);
            fullTextBlocks.push(...paragraphs);
          }
          if (i % 5 === 0)
            updateProgress(
              30 + Math.round((i / totalItems) * 30),
              `Đang đọc chương ${i + 1}/${totalItems}`
            );
        }
        return { fullTextBlocks, title, author, coverUrl };
      }

      function analyzeText(paragraphs) {
        let totalWords = 0;
        const errorMap = new Map();
        const wordRegex = /[\p{L}\p{M}]+/giu;

        const isFrontVowel = (c) => {
          if (!c) return false;
          const norm = c
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toLowerCase();
          return ["i", "e"].includes(norm) || norm === "ê";
        };
        const isY = (c) =>
          c &&
          c
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "") === "y";

        paragraphs.forEach((para) => {
          let match;
          while ((match = wordRegex.exec(para)) !== null) {
            const word = match[0];
            totalWords++;
            if (word.length < 2) continue;

            const lower = word.normalize("NFC").toLowerCase();
            const isCapitalized = /^\p{Lu}/u.test(word);

            if (IGNORED_WORDS.has(lower.toLowerCase())) continue;

            const errorTypes = [];
            
            if ((word.match(/\p{Lu}/gu) || []).length > 1) {
              errorTypes.push("Lỗi viết hoa");
            }

            if (isDictLoaded) {
              if (!validSyllables.has(lower.toLowerCase())) {
                  if (/[fjwz]/.test(lower)) {
                    errorTypes.push("Từ lạ / Tiếng nước ngoài");
                  } else if (/(aa|ee|oo|dd|js|kx|wt)$/.test(lower)) {
                    errorTypes.push("Lỗi gõ máy");
                  } else {
                    errorTypes.push("Không có trong từ điển");
                  }
              }
            } else {
              if (/[fjwz]/.test(lower)) {
                errorTypes.push("Chứa ký tự lạ (f, j, w, z)");
              } else if (lower.startsWith("ngh") && !isFrontVowel(lower[3]))
                errorTypes.push("Sai quy tắc ngh");
              else if (lower.startsWith("ng") && isFrontVowel(lower[2]))
                errorTypes.push("Sai quy tắc ng");
              else if (lower.startsWith("gh") && !isFrontVowel(lower[2]))
                errorTypes.push("Sai quy tắc gh");
              else if (
                lower.startsWith("g") &&
                isFrontVowel(lower[1]) &&
                lower.substring(0, 2) !== "gi"
              )
                errorTypes.push("Sai quy tắc g");
              else if (
                lower.startsWith("k") &&
                !lower.startsWith("kh") &&
                !isFrontVowel(lower[1]) &&
                !isY(lower[1])
              )
                errorTypes.push("Sai quy tắc k");
              else if (
                lower.startsWith("c") &&
                !lower.startsWith("ch") &&
                (isFrontVowel(lower[1]) || isY(lower[1]))
              )
                errorTypes.push("Sai quy tắc c");
            }

            if (errorTypes.length > 0) {
              const key = lower; // Group by word
              if (!errorMap.has(key)) {
                errorMap.set(key, {
                  id: key,
                  word: word,
                  types: [],
                  contexts: [],
                });
              }
              const errorGroup = errorMap.get(key);
              errorGroup.contexts.push(getContext(para, match.index, word.length));
              // Add types if they are not already there
              errorTypes.forEach(type => {
                if (!errorGroup.types.includes(type)) {
                  errorGroup.types.push(type);
                }
              });
            }
          }
        });

        statTotalWords.innerText = totalWords.toLocaleString();
        allDetectedErrors = Array.from(errorMap.values()).sort(
          (a, b) => b.contexts.length - a.contexts.length
        );
        filterAndRenderErrors();
      }

      function filterAndRenderErrors() {
        const filteredErrors = allDetectedErrors.filter((group) => {
          return !IGNORED_WORDS.has(group.id);
        });
        const totalErrors = filteredErrors.reduce(
          (acc, curr) => acc + curr.contexts.length,
          0
        );
        statErrors.innerText = totalErrors.toLocaleString();
        statGroups.innerText = filteredErrors.length.toLocaleString();
        renderErrors(filteredErrors);
      }

      // Quick Ignore Function
      function quickIgnore(word) {
        const currentVal = whitelistInput.value;
        const separator = currentVal.trim() ? ", " : "";
        // Add word to input
        whitelistInput.value = currentVal + separator + word;

        // Trigger save and filter logic
        saveWhitelist();
        updateIgnoredWords(); // Ensure IGNORED_WORDS is rebuilt and then filtering happens

        // Clear current context if the ignored word was selected
        if (currentGroup && currentGroup.word === word) {
          contextView.innerHTML =
            '<div class="text-center p-6 border-2 border-dashed border-slate-800 rounded-xl"><p class="text-lg mb-2">Đã bỏ qua</p><p class="text-sm opacity-60">Chọn mục khác từ danh sách</p></div>';
          contextNav.classList.add("hidden");
          currentGroup = null;
        }
      }

      function levenshteinDistance(a, b) {
        if (a.length === 0) return b.length;
        if (b.length === 0) return a.length;
        const matrix = [];
        for (let i = 0; i <= b.length; i++) matrix[i] = [i];
        for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
        for (let i = 1; i <= b.length; i++) {
          for (let j = 1; j <= a.length; j++) {
            if (b.charAt(i - 1) === a.charAt(j - 1))
              matrix[i][j] = matrix[i - 1][j - 1];
            else
              matrix[i][j] = Math.min(
                matrix[i - 1][j - 1] + 1,
                Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1)
              );
          }
        }
        return matrix[b.length][a.length];
      }

      function findSuggestions(wrongWord) {
        if (!isDictLoaded) return [];
        const suggestions = [];
        const maxDistance = wrongWord.length < 4 ? 1 : 2;
        const lowerWrong = wrongWord.toLowerCase();
        for (const word of validSyllables) {
          if (Math.abs(word.length - lowerWrong.length) > maxDistance) continue;
          const dist = levenshteinDistance(lowerWrong, word);
          if (dist <= maxDistance && dist > 0) suggestions.push({ word, dist });
        }
        return suggestions
          .sort((a, b) => a.dist - b.dist)
          .slice(0, 5)
          .map((s) => s.word);
      }

      function quickLookup(word) {
        const url = `https://vi.wiktionary.org/wiki/${encodeURIComponent(word)}`;
        window.open(url, "_blank");
      }

      function getContext(text, index, length) {
        const start = Math.max(0, index - 60);
        const end = Math.min(text.length, index + length + 60);
        let prefix = escapeHtml(text.substring(start, index));
        let suffix = escapeHtml(text.substring(index + length, end));
        let target = escapeHtml(text.substr(index, length));
        if (start > 0) prefix = "..." + prefix;
        if (end < text.length) suffix = suffix + "...";
        return { prefix, target, suffix };
      }

      function renderErrors(groups) {
        errorList.innerHTML = "";
        currentActiveButton = null;
        if (currentGroup) {
          const stillExists = groups.find((g) => g.id === currentGroup.id);
          if (!stillExists) {
            contextView.innerHTML =
              '<div class="text-center p-6 border-2 border-dashed border-slate-800 rounded-xl"><p class="text-lg mb-2">Chưa chọn lỗi nào</p><p class="text-sm opacity-60">Chọn một mục từ danh sách bên trái</p></div>';
            contextNav.classList.add("hidden");
            currentGroup = null;
          }
        }
        if (groups.length === 0) {
          errorList.innerHTML =
            '<div class="p-10 text-center text-slate-600 flex flex-col items-center"><svg class="w-16 h-16 mb-4 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="text-lg font-medium">Tuyệt vời!</p><p class="text-sm mt-1">Không tìm thấy lỗi nào (hoặc đã được lọc hết).</p></div>';
          return;
        }
        const template = document.getElementById("error-item-template");
        const fragment = document.createDocumentFragment();
        groups.forEach((group) => {
          const clone = template.content.cloneNode(true);
          clone.querySelector(".error-word").innerText = group.word;
          clone.querySelector(".error-reason").innerText = group.types.join(", ");
          clone.querySelector(".error-count").innerText = group.contexts.length;

          // Select button
          const selectBtn = clone.querySelector(".select-btn");

          if (currentGroup && currentGroup.id === group.id) {
            selectBtn.classList.add(
              "bg-blue-900/30",
              "border-blue-700/50",
              "ring-1",
              "ring-blue-500/50"
            );
            selectBtn.classList.remove("border-transparent", "border-r");
            currentActiveButton = selectBtn; // Track the active button
          }

          selectBtn.onclick = (e) => selectGroup(group, selectBtn);

          // Ignore button
          const ignoreBtn = clone.querySelector(".ignore-btn");
          ignoreBtn.onclick = (e) => {
            e.stopPropagation(); // Stop event bubbling
            quickIgnore(group.word);
          };

          fragment.appendChild(clone);
        });
        errorList.appendChild(fragment);
      }

      function selectGroup(group, btnElement) {
        currentGroup = group;
        currentInstanceIndex = 0;

        // Reset styles for previous active item
        if (currentActiveButton && currentActiveButton !== btnElement) {
          currentActiveButton.classList.remove(
            "bg-blue-900/30",
            "border-blue-700/50",
            "ring-1",
            "ring-blue-500/50"
          );
          currentActiveButton.classList.add("border-transparent", "border-r");
        }

        // Apply style to current
        btnElement.classList.add(
          "bg-blue-900/30",
          "border-blue-700/50",
          "ring-1",
          "ring-blue-500/50"
        );
        btnElement.classList.remove("border-transparent", "border-r");
        currentActiveButton = btnElement;

        if (group.contexts.length > 1) contextNav.classList.remove("hidden");
        else contextNav.classList.add("hidden");
        updateContextView();
      }

      function getStyleForTypes(types, forHighlight = false) {
        const colorMap = {
          "Không có trong từ điển": "rgb(239, 68, 68)", // red-500
          "Lỗi viết hoa": "rgb(245, 158, 11)", // amber-500
          "Lỗi gõ máy": "rgb(168, 85, 247)", // purple-500
          "Từ lạ / Tiếng nước ngoài": "rgb(59, 130, 246)", // blue-500
          "Sai quy tắc ngh": "rgb(236, 72, 153)", // pink-500
          "Sai quy tắc ng": "rgb(236, 72, 153)",
          "Sai quy tắc gh": "rgb(236, 72, 153)",
          "Sai quy tắc g": "rgb(236, 72, 153)",
          "Sai quy tắc k": "rgb(236, 72, 153)",
          "Sai quy tắc c": "rgb(236, 72, 153)",
        };

        if (forHighlight && types.length > 0) {
          // For the main word highlight, use a consistent error color if multiple types, otherwise use the primary type's color
          return `background-color: ${colorMap[types[0]] || "rgb(239, 68, 68)"};`;
        } else if (types.length === 1) {
          return `background-color: ${colorMap[types[0]] || "rgb(100, 116, 139)"};`;
        } else if (types.length > 1) {
          // For the small color indicator, use a gradient if multiple types
          const colors = types.map(type => colorMap[type] || "rgb(100, 116, 139)");
          return `background-image: linear-gradient(to right, ${colors.map(c => `${c}B0`).join(", ")});`; // Add 70% opacity
        }
        return "";
      }

      function updateContextView() {
        if (!currentGroup) return;
        const context = currentGroup.contexts[currentInstanceIndex];
        const total = currentGroup.contexts.length;
        const suggestions = findSuggestions(currentGroup.word);
        
        const highlightStyle = getStyleForTypes(currentGroup.types, true);

        const suggestionHTML =
          suggestions.length > 0
            ? `<div class="mt-4 flex flex-wrap justify-center gap-2">
                     <span class="text-sm text-slate-400 mr-1 self-center">Gợi ý:</span>
                     ${suggestions
                       .map(
                         (s) =>
                           `<span class="bg-green-900/30 text-green-400 border border-green-700/50 px-2 py-1 rounded text-sm cursor-pointer hover:bg-green-800/50">${s}</span>`
                       )
                       .join("")}
                   </div>`
            : "";

        const reasonHTML = currentGroup.types.map(type => {
          const colorMap = {
            "Không có trong từ điển": "text-red-400",
            "Lỗi viết hoa": "text-amber-400",
            "Lỗi gõ máy": "text-purple-400",
            "Từ lạ / Tiếng nước ngoài": "text-blue-400",
          };
          const textColor = colorMap[type] || "text-pink-400";
          
          let reasonContent = `<span class="${textColor} font-medium">${type}</span>`;
          if (type === "Không có trong từ điển") {
            reasonContent = `<span class="${textColor} font-medium">Không có trong từ điển</span>
                             <span
                                  onclick="event.stopPropagation(); quickLookup('${escapeHtml(currentGroup.word)}')"
                                  class="inline-block align-middle p-1.5 rounded-full bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-blue-400 cursor-pointer transition-colors"
                                  title="Tra cứu trên Wiktionary"
                                >
                                  <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5"
                                    viewBox="0 0 20 20"
                                    fill="currentColor"
                                  >
                                    <path
                                      fill-rule="evenodd"
                                      d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                                      clip-rule="evenodd"
                                    />
                                  </svg>
                                </span>`;
          }

          return `<div class="px-5 py-3 bg-slate-800 text-slate-300 rounded-lg text-sm border border-slate-700 shadow-lg flex items-center gap-3">
                    <span class="w-2 h-2 rounded-full" style="${getStyleForTypes([type]).replace('background-color', 'background')}"></span>
                    ${reasonContent}
                  </div>`
        }).join('');

        navIndicator.innerText = `${currentInstanceIndex + 1}/${total}`;
        btnPrev.disabled = currentInstanceIndex === 0;
        btnNext.disabled = currentInstanceIndex === total - 1;
        contextView.innerHTML = `
                <div class="max-w-2xl text-center w-full animate-fadeIn">
                    <div class="flex items-center justify-center gap-2 mb-6">
                        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest bg-slate-800 px-2 py-1 rounded">
                            Ngữ cảnh ${currentInstanceIndex + 1} / ${total}
                        </span>
                    </div>
                    <div class="bg-slate-900 p-8 rounded-xl border border-slate-800 shadow-inner relative">
                        <div class="text-xl leading-loose text-slate-300 font-serif">
                            ${escapeHtml(
                              context.prefix
                            )}<span style="${highlightStyle}" class="text-white px-1 py-0.5 rounded border-b-2 border-red-500 font-bold mx-0.5 shadow-[0_0_15px_rgba(239,68,68,0.2)]">${escapeHtml(
          context.target
        )}</span>${escapeHtml(context.suffix)}
                        </div>
                    </div>
                    <div class="mt-8 flex flex-col items-center justify-center gap-4">
                        ${reasonHTML}
                        ${suggestionHTML}
                    </div>
                </div>
            `;
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      const style = document.createElement("style");
      style.textContent = `
            @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
            .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        `;
      document.head.appendChild(style);
      btnPrev.addEventListener("click", () => {
        if (currentInstanceIndex > 0) {
          currentInstanceIndex--;
          updateContextView();
        }
      });

      btnNext.addEventListener("click", () => {
        if (currentGroup && currentInstanceIndex < currentGroup.contexts.length - 1) {
          currentInstanceIndex++;
          updateContextView();
        }
      });
    </script>
  </body>
</html>
