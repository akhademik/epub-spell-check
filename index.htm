<!DOCTYPE html>
<html lang="vi" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Soát lỗi chính tả</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              slate: {
                850: "#1e293b",
                900: "#0f172a",
                950: "#020617",
              },
            },
            fontFamily: {
              sans: ['"Noto Sans"', "sans-serif"],
              serif: ['"Noto Serif"', "serif"],
            },
          },
        },
      };
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Serif:wght@400;700&display=swap");
      body {
        font-family: "Noto Sans", sans-serif;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fadeIn {
        animation: fadeIn 0.3s ease-out forwards;
      }
    </style>
  </head>
  <body
    class="bg-slate-950 text-slate-200 min-h-screen flex flex-col transition-colors duration-300"
  >
    <!-- Header -->
    <header
      class="bg-slate-900 border-b border-slate-800 sticky top-0 z-20 shadow-md"
    >
      <div
        class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between"
      >
        <div class="flex items-center gap-3">
          <div
            class="bg-blue-600 text-white p-2 rounded-lg shadow-lg shadow-blue-900/20"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              />
            </svg>
          </div>
          <div>
            <h1 class="text-xl font-bold text-slate-100 tracking-tight">
              Soát Lỗi Chính Tả EPUB
            </h1>
            <div class="text-xs text-slate-500 font-medium">
              v1.29 - 29/12/2005
            </div>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <!-- Settings Button -->
          <button
            id="settings-btn"
            class="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors"
            title="Cấu hình (Settings)"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
          </button>

          <!-- Export Button -->
          <button
            id="export-btn"
            class="hidden px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-sm font-medium transition-colors shadow-lg shadow-emerald-900/20 flex items-center gap-2"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
              />
            </svg>
            <span class="hidden sm:inline">Xuất lỗi (.txt)</span>
          </button>

          <!-- Reset Button -->
          <button
            id="reset-btn"
            class="hidden px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-medium transition-colors shadow-lg shadow-blue-900/20 flex items-center gap-2"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              />
            </svg>
            <span class="hidden sm:inline">Kiểm tra file khác</span>
          </button>

          <!-- Dict Status -->
          <div
            id="dict-status"
            class="hidden md:flex items-center gap-3 text-xs px-3 py-1.5 rounded-xl bg-slate-800 border border-slate-700 h-auto"
          >
            <div
              class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse flex-shrink-0"
              id="dict-dot"
            ></div>
            <div
              id="dict-text"
              class="text-slate-400 font-mono leading-tight whitespace-nowrap"
            >
              Đang tải dữ liệu...
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main
      class="flex-grow max-w-6xl mx-auto px-4 py-8 w-full flex flex-col gap-6 relative"
    >
      <!-- Settings Modal (Hidden by default) -->
      <div
        id="settings-modal"
        class="hidden absolute top-0 right-4 z-50 w-80 bg-slate-900 border border-slate-700 rounded-xl shadow-2xl p-5 animate-fadeIn"
      >
        <div
          class="flex justify-between items-center mb-4 pb-2 border-b border-slate-800"
        >
          <h3 class="text-lg font-bold text-white">Cấu hình kiểm tra</h3>
          <button
            id="close-settings-btn"
            class="text-slate-500 hover:text-white"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <!-- Setting Item: Dictionary Check -->
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-300"
              >Lỗi không có trong từ điển</span
            >
            <label
              for="set-dict"
              class="relative inline-block w-10 h-6 cursor-pointer"
            >
              <input
                type="checkbox"
                id="set-dict"
                class="sr-only peer"
                checked
              />
              <div
                class="w-10 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"
              ></div>
            </label>
          </div>

          <!-- Setting Item: Uppercase Check -->
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-300">Lỗi viết hoa (VD: tÔI)</span>
            <label
              for="set-case"
              class="relative inline-block w-10 h-6 cursor-pointer"
            >
              <input
                type="checkbox"
                id="set-case"
                class="sr-only peer"
                checked
              />
              <div
                class="w-10 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"
              ></div>
            </label>
          </div>

          <!-- Setting Item: Tone Check -->
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-300">Lỗi đặt dấu (Hòa/Hoà)</span>
            <label
              for="set-tone"
              class="relative inline-block w-10 h-6 cursor-pointer"
            >
              <input
                type="checkbox"
                id="set-tone"
                class="sr-only peer"
                checked
              />
              <div
                class="w-10 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"
              ></div>
            </label>
          </div>

          <!-- Setting Item: Foreign/Structure Check -->
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-300">Lỗi ký tự lạ / Cấu trúc</span>
            <label
              for="set-struct"
              class="relative inline-block w-10 h-6 cursor-pointer"
            >
              <input
                type="checkbox"
                id="set-struct"
                class="sr-only peer"
                checked
              />
              <div
                class="w-10 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"
              ></div>
            </label>
          </div>
        </div>

        <div class="mt-4 pt-3 border-t border-slate-800 text-xs text-slate-500">
          <p class="mb-1 font-bold text-slate-400">Phím tắt:</p>
          <div class="grid grid-cols-2 gap-2">
            <div>⬆️ ⬇️ : Di chuyển</div>
            <div>Delete / I : Bỏ qua</div>
          </div>
        </div>
      </div>

      <!-- Upload Section -->
      <div
        id="upload-section"
        class="bg-slate-900 rounded-2xl shadow-xl border-2 border-dashed border-slate-800 p-12 text-center transition-all hover:border-blue-500/50 hover:bg-slate-800/50 group cursor-pointer relative overflow-hidden"
      >
        <input type="file" id="file-input" accept=".epub" class="hidden" />

        <div
          class="absolute inset-0 bg-gradient-to-br from-blue-500/5 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity"
        ></div>

        <div
          class="relative z-10 flex flex-col items-center justify-center gap-6 pointer-events-none"
        >
          <div
            class="w-20 h-20 bg-slate-800 text-blue-500 rounded-full flex items-center justify-center group-hover:scale-110 group-hover:bg-slate-700 group-hover:text-blue-400 transition-all duration-300 shadow-lg shadow-black/20"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-10 w-10"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
              />
            </svg>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-slate-200">Tải lên sách EPUB</h2>
            <p class="text-slate-400 mt-2 text-lg">
              Kéo thả hoặc nhấp để chọn tệp
            </p>
          </div>
          <div class="flex gap-4 mt-2">
            <span
              class="px-3 py-1 rounded bg-slate-800 border border-slate-700 text-xs text-slate-500"
              >Chỉ hỗ trợ .epub</span
            >
            <span
              class="px-3 py-1 rounded bg-slate-800 border border-slate-700 text-xs text-slate-500"
              >Xử lý cục bộ</span
            >
          </div>
        </div>
      </div>

      <!-- Processing UI -->
      <div
        id="processing-ui"
        class="hidden bg-slate-900 p-8 rounded-2xl shadow-xl border border-slate-800 max-w-2xl mx-auto w-full"
      >
        <div class="flex justify-between items-end mb-4">
          <div>
            <h3 class="text-lg font-semibold text-white mb-1">
              Đang phân tích
            </h3>
            <div id="status-text" class="text-slate-400 text-sm">
              Đang khởi tạo...
            </div>
          </div>
          <span id="progress-percent" class="text-3xl font-bold text-blue-500"
            >0%</span
          >
        </div>
        <div
          class="w-full bg-slate-800 rounded-full h-3 overflow-hidden box-border border border-slate-700/50"
        >
          <div
            id="progress-bar"
            class="bg-gradient-to-r from-blue-600 to-indigo-600 h-full rounded-full transition-all duration-300 shadow-[0_0_10px_rgba(37,99,235,0.5)]"
            style="width: 0%"
          ></div>
        </div>
      </div>

      <!-- Results Section -->
      <div id="results-section" class="hidden flex flex-col gap-6">
        <!-- Book Info -->
        <div
          class="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-lg flex items-center gap-5 relative overflow-hidden min-h-[140px]"
        >
          <div
            class="absolute right-0 top-0 p-6 opacity-10 pointer-events-none"
          >
            <svg
              class="w-40 h-40 text-white"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1"
                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
              />
            </svg>
          </div>

          <!-- Cover Image Container -->
          <div
            class="w-20 h-28 bg-slate-800 rounded-lg flex-shrink-0 border border-slate-700 overflow-hidden relative shadow-md"
          >
            <img
              id="meta-cover"
              class="w-full h-full object-cover hidden"
              alt="Bìa sách"
            />
            <div
              id="meta-cover-placeholder"
              class="w-full h-full flex items-center justify-center text-slate-600"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-8 w-8"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
                />
              </svg>
            </div>
          </div>

          <div class="relative z-10">
            <div
              class="text-xs text-blue-400 font-bold uppercase tracking-wider mb-1"
            >
              Đang kiểm tra
            </div>
            <h2
              id="meta-title"
              class="text-2xl font-bold text-white leading-tight"
            >
              Đang tải...
            </h2>
            <p
              id="meta-author"
              class="text-slate-400 mt-1 font-serif italic text-lg"
            >
              Đang tải...
            </p>
          </div>
        </div>

        <!-- Whitelist Input -->
        <div
          class="bg-slate-900 p-5 rounded-xl border border-slate-800 shadow-lg"
        >
          <div class="flex items-center justify-between mb-3">
            <label
              for="whitelist-input"
              class="flex items-center gap-2 text-sm font-bold text-slate-300"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4 text-green-500"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              Danh sách từ bỏ soát lỗi
            </label>
            <span class="text-xs text-slate-500"
              >Tự động cập nhật & lưu kết quả</span
            >
          </div>
          <textarea
            id="whitelist-input"
            rows="2"
            class="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-slate-200 text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500 placeholder-slate-600 transition-colors"
            placeholder="Nhập các từ muốn bỏ qua, cách nhau bằng dấu phẩy, khoảng trắng hoặc xuống dòng (Ví dụ: tên nhân vật, địa danh lạ...)"
          ></textarea>

          <!-- English Filter Checkbox -->
          <div
            class="flex items-center gap-2 mt-4 pt-3 border-t border-slate-800"
          >
            <input
              type="checkbox"
              id="eng-filter-checkbox"
              class="w-4 h-4 text-blue-600 rounded bg-slate-800 border-slate-600 focus:ring-blue-500 focus:ring-offset-slate-900"
            />
            <label
              for="eng-filter-checkbox"
              class="text-sm font-medium text-slate-300 cursor-pointer select-none flex items-center gap-2"
            >
              Kích hoạt từ tiếng Anh
              <span
                id="eng-loading"
                class="hidden text-xs text-yellow-500 animate-pulse flex items-center gap-1"
              >
                <svg
                  class="animate-spin h-3 w-3"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
                Đang tải...
              </span>
            </label>
          </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div
            class="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-lg relative overflow-hidden"
          >
            <div class="absolute right-0 top-0 p-4 opacity-5">
              <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 20 20">
                <path
                  d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.968 7.968 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"
                />
              </svg>
            </div>
            <div
              class="text-slate-500 text-sm font-medium mb-1 uppercase tracking-wider"
            >
              Từ đã quét
            </div>
            <div
              id="stat-total-words"
              class="text-3xl font-bold text-slate-100"
            >
              0
            </div>
          </div>
          <div
            class="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-lg relative overflow-hidden group"
          >
            <div class="absolute right-0 top-0 p-4 opacity-5 text-red-500">
              <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <div
              class="text-red-400 text-sm font-medium mb-1 uppercase tracking-wider"
            >
              Lỗi phát hiện
            </div>
            <div
              id="stat-errors"
              class="text-3xl font-bold text-red-500 group-hover:scale-105 transition-transform origin-left"
            >
              0
            </div>
          </div>
          <div
            class="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-lg relative overflow-hidden"
          >
            <div class="absolute right-0 top-0 p-4 opacity-5 text-blue-500">
              <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 20 20">
                <path
                  d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"
                />
              </svg>
            </div>
            <div
              class="text-blue-400 text-sm font-medium mb-1 uppercase tracking-wider"
            >
              Nhóm lỗi
            </div>
            <div id="stat-groups" class="text-3xl font-bold text-blue-400">
              0
            </div>
          </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-6 h-[600px] lg:h-[700px]">
          <!-- Error List Sidebar -->
          <div
            class="w-full lg:w-1/3 flex flex-col bg-slate-900 rounded-2xl border border-slate-800 shadow-xl overflow-hidden"
          >
            <div
              class="p-4 border-b border-slate-800 bg-slate-900/50 backdrop-blur font-semibold text-slate-300 flex justify-between items-center"
            >
              <span class="flex items-center gap-2">
                <svg
                  class="w-4 h-4 text-slate-500"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6h16M4 10h16M4 14h16M4 18h16"
                  />
                </svg>
                Danh sách lỗi
              </span>
              <div
                class="text-xs px-2 py-1 rounded bg-slate-800 text-slate-500 border border-slate-700"
              >
                Sắp xếp theo tần suất
              </div>
            </div>
            <div
              id="error-list"
              class="flex-1 overflow-y-auto p-2 space-y-1 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent"
            >
              <!-- Items will be injected here -->
            </div>
          </div>

          <!-- Context Preview -->
          <div
            class="w-full lg:w-2/3 flex flex-col bg-slate-900 rounded-2xl border border-slate-800 shadow-xl overflow-hidden"
          >
            <div
              class="p-4 border-b border-slate-800 bg-slate-900/50 backdrop-blur font-semibold text-slate-300 flex justify-between items-center"
            >
              <span class="flex items-center gap-2">
                <svg
                  class="w-4 h-4 text-slate-500"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                  />
                </svg>
                Ngữ cảnh
              </span>
              <div
                id="context-nav"
                class="hidden flex items-center gap-2 text-sm bg-slate-800 rounded-lg p-1 border border-slate-700"
              >
                <button
                  id="btn-prev"
                  class="p-1.5 hover:bg-slate-700 rounded-md text-slate-400 hover:text-white disabled:opacity-30 transition-colors"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </button>
                <span
                  id="nav-indicator"
                  class="font-mono text-slate-300 min-w-[3rem] text-center text-xs"
                  >1/1</span
                >
                <button
                  id="btn-next"
                  class="p-1.5 hover:bg-slate-700 rounded-md text-slate-400 hover:text-white disabled:opacity-30 transition-colors"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </button>
              </div>
            </div>
            <div
              id="context-view"
              class="flex-1 p-8 overflow-y-auto flex flex-col items-center justify-center text-slate-500 bg-slate-950/50 relative"
            >
              <div
                class="text-center p-6 border-2 border-dashed border-slate-800 rounded-xl"
              >
                <p class="text-lg mb-2">Chưa chọn lỗi nào</p>
                <p class="text-sm opacity-60">
                  Chọn một mục từ danh sách bên trái
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer
      class="mt-auto py-6 text-center text-white text-sm border-t border-slate-900 bg-slate-950"
    >
      <p class="font-medium">.:: Akhademik 2025 ::.</p>
    </footer>

    <!-- Templates -->
    <template id="error-item-template">
      <div
        class="w-full flex items-stretch rounded-lg hover:bg-slate-800 group transition-all mb-1 bg-slate-900 border border-transparent hover:border-slate-700"
      >
        <button
          class="select-btn flex-grow text-left px-4 py-3 flex items-center justify-between focus:outline-none rounded-l-lg border-r border-slate-800/50 group-hover:border-slate-700"
        >
          <div class="overflow-hidden w-full">
            <div class="flex items-center gap-2">
              <!-- Dot will be injected here -->
              <span
                class="status-dot w-2.5 h-2.5 rounded-full flex-shrink-0 shadow-[0_0_5px_rgba(0,0,0,0.5)]"
              ></span>
              <!-- Changed text color to white/slate-200 for better contrast against dot -->
              <span
                class="font-bold text-slate-200 error-word text-lg truncate font-serif"
              ></span>
              <span
                class="bg-slate-800 text-slate-400 border border-slate-700 text-[10px] font-bold px-2 py-0.5 rounded-full error-count flex-shrink-0"
              ></span>
            </div>
            <div
              class="text-xs text-slate-500 mt-1 error-reason truncate"
            ></div>
          </div>
        </button>
        <button
          class="ignore-btn px-3 flex items-center justify-center text-slate-600 hover:text-green-400 hover:bg-slate-800/50 rounded-r-lg transition-colors"
          title="Bỏ qua (Whitelist)"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"
            />
          </svg>
        </button>
      </div>
    </template>

    <script>
      // --- CONFIGURATION ---
      const ENG_DICT_URL = "final_en_words.txt";
      const DICT_URL = "final_vn_words.txt";
      const STORAGE_KEY = "vn_spell_whitelist";
      const SETTINGS_KEY = "vn_spell_settings";

      const IGNORED_WORDS = new Set([
        "email",
        "internet",
        "web",
        "website",
        "video",
        "clip",
        "camera",
        "fan",
        "comment",
        "live",
        "show",
        "team",
        "ok",
        "marketing",
        "sale",
        "deal",
        "ship",
        "shipper",
        "order",
        "check",
        "boss",
        "admin",
        "post",
        "status",
        "link",
        "share",
        "view",
        "like",
        "download",
        "upload",
        "app",
        "game",
        "menu",
        "list",
        "top",
        "hot",
        "cool",
        "pro",
        "vip",
        "scan",
        "smartphone",
        "laptop",
        "mouse",
        "keyboard",
        "wifi",
        "pixel",
        "digital",
        "design",
        "designer",
        "media",
        "studio",
        "content",
        "pr",
        "mc",
        "dj",
        "ceo",
        "facebook",
        "google",
        "youtube",
        "instagram",
        "tiktok",
        "zalo",
        "shopee",
        "tiki",
        "lazada",
        "grab",
        "uber",
        "be",
        "now",
        "baemin",
        "food",
        "coffee",
        "cafe",
        "bar",
        "club",
        "pub",
        "gym",
        "spa",
        "yoga",
        "tennis",
        "golf",
        "tour",
        "guide",
        "review",
        "vlog",
        "blog",
        "blogger",
        "streamer",
        "startup",
        "bonus",
        "combo",
        "concept",
        "event",
        "fashion",
        "style",
        "trend",
        "hit",
        "teen",
        "idol",
        "poster",
        "banner",
        "logo",
        "slogan",
        "background",
        "format",
        "version",
        "update",
        "level",
        "skill",
        "job",
        "cv",
        "interview",
        "deadline",
        "project",
        "target",
        "kpi",
        "budget",
        "data",
        "database",
        "server",
        "code",
        "coder",
        "bug",
        "fix",
        "error",
        "message",
        "chat",
        "inbox",
        "online",
        "offline",
        "free",
        "voucher",
        "coupon",
        "bill",
        "iphone",
        "ipad",
        "android",
        "ios",
        "sms",
        "sim",
      ]);

      const TONE_MISPLACEMENT = {
        oá: "óa",
        oà: "òa",
        oả: "ỏa",
        oã: "õa",
        oạ: "ọa",
        oé: "óe",
        oè: "òe",
        oẻ: "ỏe",
        oẽ: "õe",
        oẹ: "ọe",
      };

      // DOM Elements
      const fileInput = document.getElementById("file-input");
      const uploadSection = document.getElementById("upload-section");
      const processingUi = document.getElementById("processing-ui");
      const progressBar = document.getElementById("progress-bar");
      const progressPercent = document.getElementById("progress-percent");
      const statusText = document.getElementById("status-text");
      const resultsSection = document.getElementById("results-section");
      const errorList = document.getElementById("error-list");
      const contextView = document.getElementById("context-view");

      // Metadata & Cover Elements
      const metaTitle = document.getElementById("meta-title");
      const metaAuthor = document.getElementById("meta-author");
      const metaCover = document.getElementById("meta-cover");
      const metaCoverPlaceholder = document.getElementById(
        "meta-cover-placeholder"
      );

      // Whitelist, Reset & Export, Eng Filter
      const whitelistInput = document.getElementById("whitelist-input");
      const resetBtn = document.getElementById("reset-btn");
      const exportBtn = document.getElementById("export-btn");
      const engFilterCheckbox = document.getElementById("eng-filter-checkbox");
      const engLoading = document.getElementById("eng-loading");

      // Settings UI
      const settingsBtn = document.getElementById("settings-btn");
      const settingsModal = document.getElementById("settings-modal");
      const closeSettingsBtn = document.getElementById("close-settings-btn");

      // Dictionary Status Elements
      const dictStatus = document.getElementById("dict-status");
      const dictDot = document.getElementById("dict-dot");
      const dictText = document.getElementById("dict-text");

      // Navigation Elements
      const contextNav = document.getElementById("context-nav");
      const btnPrev = document.getElementById("btn-prev");
      const btnNext = document.getElementById("btn-next");
      const navIndicator = document.getElementById("nav-indicator");

      // Stats Elements
      const statTotalWords = document.getElementById("stat-total-words");
      const statErrors = document.getElementById("stat-errors");
      const statGroups = document.getElementById("stat-groups");

      // State
      let allDetectedErrors = [];
      let currentFilteredErrors = [];
      let currentGroup = null;
      let currentInstanceIndex = 0;
      let validSyllables = new Set();
      let engWords = new Set();
      let isDictLoaded = false;
      let isEngDictLoaded = false;
      let isEngFilterEnabled = false;
      let isEngDictLoading = false;
      let currentCoverUrl = null;
      let currentBookTitle = "";
      let loadedTextContent = []; // Fix: Store parsed text globally

      // Settings State
      let checkSettings = {
        dictionary: true,
        uppercase: true,
        tone: true,
        foreign: true,
      };

      // --- PERSISTENCE ---
      function loadWhitelist() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          whitelistInput.value = saved;
        }
      }

      function saveWhitelist() {
        localStorage.setItem(STORAGE_KEY, whitelistInput.value);
      }

      function loadSettings() {
        const saved = localStorage.getItem(SETTINGS_KEY);
        if (saved) {
          checkSettings = JSON.parse(saved);
          document.getElementById("set-dict").checked =
            checkSettings.dictionary;
          document.getElementById("set-case").checked = checkSettings.uppercase;
          document.getElementById("set-tone").checked = checkSettings.tone;
          document.getElementById("set-struct").checked = checkSettings.foreign;
        }
      }

      function saveSettings() {
        checkSettings.dictionary = document.getElementById("set-dict").checked;
        checkSettings.uppercase = document.getElementById("set-case").checked;
        checkSettings.tone = document.getElementById("set-tone").checked;
        checkSettings.foreign = document.getElementById("set-struct").checked;

        localStorage.setItem(SETTINGS_KEY, JSON.stringify(checkSettings));

        // Fix: Re-analyze immediately if text is loaded
        if (loadedTextContent.length > 0) {
          analyzeText(loadedTextContent);
        }
      }

      // Define isY and isFrontVowel GLOBALLY to avoid ReferenceError
      const wordRegex = /[\p{L}\p{M}]+/gu;

      const isFrontVowel = (c) => {
        if (!c) return false;
        const norm = c
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toLowerCase();
        return ["i", "e"].includes(norm) || norm === "ê";
      };
      const isY = (c) =>
        c &&
        c
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "") === "y";

      // --- DICTIONARY LOADING ---
      async function loadDictionaries() {
        try {
          dictStatus.classList.remove("hidden");
          dictText.innerText = "Đang tải dữ liệu...";

          const [vnRes, enRes] = await Promise.all([
            fetch(DICT_URL),
            fetch(ENG_DICT_URL),
          ]);

          if (vnRes.ok) {
            const text = await vnRes.text();
            text.split(/\r?\n/).forEach((w) => {
              const cleanW = w.trim().toLowerCase().normalize("NFC");
              if (cleanW) {
                const parts = cleanW.split(/\s+/);
                parts.forEach((p) => validSyllables.add(p));
              }
            });
            const extras = [
              "kỹ",
              "mỹ",
              "kì",
              "lí",
              "qui",
              "có",
              "hắn",
              "y",
              "gã",
              "thị",
              "nó",
              "ta",
              "ngươi",
              "chư",
              "mỗ",
              "tại",
              "bị",
              "bởi",
              "chăng",
            ];
            extras.forEach((w) => validSyllables.add(w.normalize("NFC")));
            isDictLoaded = true;
          }

          if (enRes.ok) {
            const text = await enRes.text();
            text.split(/\r?\n/).forEach((w) => {
              const cleanW = w.trim().toLowerCase();
              if (cleanW) engWords.add(cleanW);
            });
            isEngDictLoaded = true;
          }

          dictDot.classList.remove("bg-yellow-500", "animate-pulse");
          if (isDictLoaded) {
            dictDot.classList.add("bg-green-500");
            dictText.innerHTML = `
                        <div class="flex flex-col items-start leading-snug">
                            <span>VN: ${validSyllables.size.toLocaleString()} từ</span>
                            <span>EN: ${engWords.size.toLocaleString()} từ</span>
                        </div>
                    `;
          } else {
            dictDot.classList.add("bg-red-500");
            dictText.innerText = "Lỗi tải dữ liệu";
          }
        } catch (err) {
          console.error("Critical error loading dictionaries:", err);
          dictDot.classList.remove("bg-yellow-500", "animate-pulse");
          dictDot.classList.add("bg-red-500");
          dictText.innerText = "Lỗi kết nối";
        }
      }

      loadDictionaries();
      loadWhitelist();
      loadSettings();

      uploadSection.addEventListener("click", () => fileInput.click());
      uploadSection.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadSection.classList.add("border-blue-500", "bg-slate-800");
      });
      uploadSection.addEventListener("dragleave", () => {
        uploadSection.classList.remove("border-blue-500", "bg-slate-800");
      });
      uploadSection.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadSection.classList.remove("border-blue-500", "bg-slate-800");
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
      });
      fileInput.addEventListener("change", (e) => {
        if (e.target.files.length) handleFile(e.target.files[0]);
      });

      resetBtn.addEventListener("click", resetApp);
      exportBtn.addEventListener("click", exportErrors);

      settingsBtn.addEventListener("click", () =>
        settingsModal.classList.remove("hidden")
      );
      closeSettingsBtn.addEventListener("click", () =>
        settingsModal.classList.add("hidden")
      );

      ["set-dict", "set-case", "set-tone", "set-struct"].forEach((id) => {
        document.getElementById(id).addEventListener("change", saveSettings);
      });

      whitelistInput.addEventListener("input", () => {
        saveWhitelist();
        filterAndRenderErrors();
      });
      engFilterCheckbox.addEventListener("change", (e) => {
        isEngFilterEnabled = e.target.checked;
        filterAndRenderErrors();
      });

      document.addEventListener("keydown", (e) => {
        if (
          document.activeElement === whitelistInput ||
          !settingsModal.classList.contains("hidden")
        )
          return;
        if (currentFilteredErrors.length === 0) return;
        if (e.key === "ArrowDown") {
          e.preventDefault();
          navigateErrors(1);
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          navigateErrors(-1);
        } else if (e.key === "Delete" || e.key.toLowerCase() === "i") {
          if (currentGroup) {
            e.preventDefault();
            quickIgnore(currentGroup.word);
          }
        }
      });

      function navigateErrors(direction) {
        let nextIndex = 0;
        if (currentGroup) {
          const currentIndex = currentFilteredErrors.findIndex(
            (g) => g.id === currentGroup.id
          );
          if (currentIndex !== -1) nextIndex = currentIndex + direction;
        }
        if (nextIndex < 0) nextIndex = 0;
        if (nextIndex >= currentFilteredErrors.length)
          nextIndex = currentFilteredErrors.length - 1;
        const nextGroup = currentFilteredErrors[nextIndex];
        if (nextGroup) {
          selectGroup(nextGroup, null);
          const listContainer = document.getElementById("error-list");
          const buttons = listContainer.querySelectorAll(".select-btn");
          if (buttons[nextIndex]) {
            buttons[nextIndex].scrollIntoView({
              block: "nearest",
              behavior: "smooth",
            });
            buttons.forEach((b) => {
              b.classList.remove(
                "bg-blue-900/30",
                "border-blue-700/50",
                "ring-1",
                "ring-blue-500/50"
              );
              b.classList.add("border-transparent", "border-r");
            });
            buttons[nextIndex].classList.add(
              "bg-blue-900/30",
              "border-blue-700/50",
              "ring-1",
              "ring-blue-500/50"
            );
            buttons[nextIndex].classList.remove(
              "border-transparent",
              "border-r"
            );
          }
        }
      }

      btnPrev.addEventListener("click", () => {
        if (currentGroup && currentInstanceIndex > 0) {
          currentInstanceIndex--;
          updateContextView();
        }
      });
      btnNext.addEventListener("click", () => {
        if (
          currentGroup &&
          currentInstanceIndex < currentGroup.contexts.length - 1
        ) {
          currentInstanceIndex++;
          updateContextView();
        }
      });

      async function handleFile(file) {
        if (!file.name.endsWith(".epub")) {
          alert("Vui lòng chọn file .epub");
          return;
        }
        isEngFilterEnabled = engFilterCheckbox.checked;
        uploadSection.classList.add("hidden");
        resultsSection.classList.add("hidden");
        processingUi.classList.remove("hidden");
        errorList.innerHTML = "";
        contextView.innerHTML =
          '<div class="text-center p-6 border-2 border-dashed border-slate-800 rounded-xl"><p class="text-lg mb-2">Chưa chọn lỗi nào</p><p class="text-sm opacity-60">Chọn một mục từ danh sách bên trái</p></div>';
        contextNav.classList.add("hidden");
        metaTitle.innerText = "Đang tải...";
        metaAuthor.innerText = "Đang tải...";
        if (currentCoverUrl) {
          URL.revokeObjectURL(currentCoverUrl);
          currentCoverUrl = null;
        }
        metaCover.src = "";
        metaCover.classList.add("hidden");
        metaCoverPlaceholder.classList.remove("hidden");

        try {
          updateProgress(10, "Đang giải nén tệp...");
          const zip = await JSZip.loadAsync(file);
          updateProgress(30, "Đang đọc cấu trúc sách...");
          const { fullTextBlocks, title, author, coverUrl } = await parseEpub(
            zip
          );

          loadedTextContent = fullTextBlocks; // Fix: Save text globally
          metaTitle.innerText = title;
          metaAuthor.innerText = author;
          currentBookTitle = title;

          if (coverUrl) {
            currentCoverUrl = coverUrl;
            metaCover.src = coverUrl;
            metaCover.classList.remove("hidden");
            metaCoverPlaceholder.classList.add("hidden");
          }

          updateProgress(60, "Đang phân tích...");
          requestAnimationFrame(() => {
            setTimeout(() => {
              analyzeText(fullTextBlocks);
              processingUi.classList.add("hidden");
              resultsSection.classList.remove("hidden");
              resetBtn.classList.remove("hidden");
              exportBtn.classList.remove("hidden");
            }, 100);
          });
        } catch (err) {
          console.error(err);
          alert("Có lỗi xảy ra: " + err.message);
          processingUi.classList.add("hidden");
          uploadSection.classList.remove("hidden");
        }
      }

      function resetApp() {
        resultsSection.classList.add("hidden");
        resetBtn.classList.add("hidden");
        exportBtn.classList.add("hidden");
        uploadSection.classList.remove("hidden");
        fileInput.value = "";
        statTotalWords.innerText = "0";
        statErrors.innerText = "0";
        statGroups.innerText = "0";
        errorList.innerHTML = "";
        contextView.innerHTML =
          '<div class="text-center p-6 border-2 border-dashed border-slate-800 rounded-xl"><p class="text-lg mb-2">Chưa chọn lỗi nào</p><p class="text-sm opacity-60">Chọn một mục từ danh sách bên trái</p></div>';
        contextNav.classList.add("hidden");
        metaTitle.innerText = "";
        metaAuthor.innerText = "";
        metaCover.src = "";
        metaCover.classList.add("hidden");
        metaCoverPlaceholder.classList.remove("hidden");
        if (currentCoverUrl) {
          URL.revokeObjectURL(currentCoverUrl);
          currentCoverUrl = null;
        }
        allDetectedErrors = [];
        currentFilteredErrors = [];
        currentGroup = null;
        currentInstanceIndex = 0;
        currentBookTitle = "";
        loadedTextContent = [];
      }

      function exportErrors() {
        const rawInput = whitelistInput.value;
        const userWhitelist = new Set();
        if (rawInput) {
          const tokens = rawInput
            .split(/[\n,\t]+/)
            .map((t) => t.trim().toLowerCase())
            .filter((t) => t.length > 0);
          tokens.forEach((t) => userWhitelist.add(t));
        }
        let filteredErrors = allDetectedErrors.filter(
          (group) => !userWhitelist.has(group.word.toLowerCase())
        );
        if (isEngFilterEnabled && isEngDictLoaded) {
          filteredErrors = filteredErrors.filter(
            (group) => !engWords.has(group.word.toLowerCase())
          );
        }
        if (filteredErrors.length === 0) {
          alert("Không có lỗi nào để xuất!");
          return;
        }
        const content = filteredErrors.map((g) => `${g.word} ==>`).join("\n\n");
        const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        let fileName = "loi-khong-ro-ten.txt";
        if (currentBookTitle) {
          const safeTitle = currentBookTitle
            .replace(/[<>:"/\\|?*\x00-\x1F]/g, "")
            .trim();
          fileName = `loi-${safeTitle}.txt`;
        }
        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function updateProgress(percent, text) {
        progressBar.style.width = percent + "%";
        progressPercent.innerText = percent + "%";
        statusText.innerText = text;
      }

      async function parseEpub(zip) {
        const containerData = await zip
          .file("META-INF/container.xml")
          .async("string");
        const parser = new DOMParser();
        const containerXml = parser.parseFromString(
          containerData,
          "application/xml"
        );
        const rootPath = containerXml
          .querySelector("rootfile")
          .getAttribute("full-path");
        const opfData = await zip.file(rootPath).async("string");
        const opfXml = parser.parseFromString(opfData, "application/xml");
        const opfDir = rootPath.substring(0, rootPath.lastIndexOf("/"));
        const resolvePath = (p) => (opfDir ? opfDir + "/" + p : p);

        const title =
          opfXml.getElementsByTagName("dc:title")[0]?.textContent ||
          opfXml.querySelector("title")?.textContent ||
          "Không rõ tên sách";
        const author =
          opfXml.getElementsByTagName("dc:creator")[0]?.textContent ||
          opfXml.querySelector("creator")?.textContent ||
          "Không rõ tác giả";

        let coverUrl = null;
        try {
          let coverHref = null;
          const coverMeta = opfXml.querySelector('meta[name="cover"]');
          if (coverMeta) {
            const coverId = coverMeta.getAttribute("content");
            const coverItem = opfXml.querySelector(
              `manifest item[id="${coverId}"]`
            );
            if (coverItem) coverHref = coverItem.getAttribute("href");
          }
          if (!coverHref) {
            const coverItem = opfXml.querySelector(
              'manifest item[properties*="cover-image"]'
            );
            if (coverItem) coverHref = coverItem.getAttribute("href");
          }
          if (coverHref) {
            const fullCoverPath = resolvePath(coverHref);
            const coverFile = zip.file(fullCoverPath);
            if (coverFile) {
              const coverBlob = await coverFile.async("blob");
              coverUrl = URL.createObjectURL(coverBlob);
            }
          }
        } catch (e) {}

        const spine = Array.from(opfXml.querySelectorAll("spine itemref")).map(
          (ref) => ref.getAttribute("idref")
        );
        const manifest = {};
        Array.from(opfXml.querySelectorAll("manifest item")).forEach((item) => {
          manifest[item.getAttribute("id")] = item.getAttribute("href");
        });

        let fullTextBlocks = [];
        let totalItems = spine.length;
        for (let i = 0; i < totalItems; i++) {
          const id = spine[i];
          const href = manifest[id];
          const fullPath = resolvePath(href);
          if (zip.file(fullPath)) {
            const htmlContent = await zip.file(fullPath).async("string");
            const doc = parser.parseFromString(htmlContent, "text/html");
            const paragraphs = Array.from(
              doc.querySelectorAll("p, h1, h2, h3, h4, h5, h6, li, div")
            )
              .map((el) => el.textContent.trim())
              .filter((text) => text.length > 0);
            fullTextBlocks.push(...paragraphs);
          }
          if (i % 5 === 0)
            updateProgress(
              30 + Math.round((i / totalItems) * 30),
              `Đang đọc chương ${i + 1}/${totalItems}`
            );
        }
        return { fullTextBlocks, title, author, coverUrl };
      }

      function getErrorHighlights(type) {
        let style = {
          dot: "bg-sky-500",
          text: "text-sky-400",
          bg: "bg-sky-500/20",
          border: "border-sky-500",
        };
        if (!type) return style;
        if (
          type.startsWith("Sai quy tắc") ||
          type.includes("Lỗi gõ máy") ||
          type.includes("Lỗi viết hoa")
        ) {
          style = {
            dot: "bg-red-500",
            text: "text-red-400",
            bg: "bg-red-500/20",
            border: "border-red-500",
          };
        } else if (type.includes("Sai vị trí dấu")) {
          style = {
            dot: "bg-orange-500",
            text: "text-orange-400",
            bg: "bg-orange-500/20",
            border: "border-orange-500",
          };
        } else if (type.includes("Từ lạ") || type.includes("ký tự lạ")) {
          style = {
            dot: "bg-pink-500",
            text: "text-pink-400",
            bg: "bg-pink-500/20",
            border: "border-pink-500",
          };
        } else if (type.includes("Không có trong từ điển")) {
          style = {
            dot: "bg-sky-500",
            text: "text-sky-400",
            bg: "bg-sky-500/20",
            border: "border-sky-500",
          };
        }
        return style;
      }

      function analyzeText(paragraphs) {
        let totalWords = 0;
        const errorMap = new Map();

        paragraphs.forEach((para) => {
          let match;
          while ((match = wordRegex.exec(para)) !== null) {
            const word = match[0];
            totalWords++;
            if (word.length < 2) continue;

            const lower = word.toLowerCase().normalize("NFC");
            const isCapitalized = /^[A-Z\u00C0-\u00DE]/.test(word);

            if (IGNORED_WORDS.has(lower)) continue;

            let errorType = null;

            if (checkSettings.uppercase) {
              const upperCount = Array.from(word).filter(
                (c) => c.toUpperCase() === c && c.toLowerCase() !== c
              ).length;
              if (upperCount >= 2) errorType = "Lỗi viết hoa (Nhiều ký tự hoa)";
            }

            if (!errorType && checkSettings.tone) {
              for (const [wrong, right] of Object.entries(TONE_MISPLACEMENT)) {
                // FIX: Only match if it's at the END of the word (Open Syllable rule for oa, oe)
                if (lower.endsWith(wrong)) {
                  errorType = "Sai vị trí dấu (Chuẩn cũ/mới)";
                  break;
                }
              }
            }

            if (!errorType && isDictLoaded && checkSettings.dictionary) {
              if (!validSyllables.has(lower)) {
                if (!isCapitalized) {
                  if (/[fjwz]/.test(lower)) {
                    if (checkSettings.foreign)
                      errorType = "Từ lạ / Tiếng nước ngoài";
                    else errorType = "Không có trong từ điển";
                  } else if (/(aa|ee|oo|dd|js|kx|wt)$/.test(lower)) {
                    errorType = "Lỗi gõ máy (Typo)";
                  } else {
                    errorType = "Không có trong từ điển";
                  }
                }
              }
            } else if (!errorType && checkSettings.foreign) {
              if (/[fjwz]/.test(lower) && !isCapitalized)
                errorType = "Chứa ký tự lạ (f, j, w, z)";
            }

            if (!errorType && checkSettings.foreign) {
              if (
                lower.startsWith("ngh") &&
                !isFrontVowel(lower[3]) &&
                !isCapitalized
              )
                errorType = "Sai quy tắc ngh";
              else if (
                lower.startsWith("ng") &&
                isFrontVowel(lower[2]) &&
                !isCapitalized
              )
                errorType = "Sai quy tắc ng";
              else if (
                lower.startsWith("gh") &&
                !isFrontVowel(lower[2]) &&
                !isCapitalized
              )
                errorType = "Sai quy tắc gh";
              // Modified G rule:
              else if (
                lower.startsWith("g") &&
                !lower.startsWith("gh") &&
                !lower.startsWith("gi") &&
                !isCapitalized
              ) {
                const c = lower[1];
                if (c) {
                  const norm = c
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "")
                    .toLowerCase();
                  if (["e", "ê"].includes(norm)) errorType = "Sai quy tắc g";
                }
              } else if (
                lower.startsWith("k") &&
                !lower.startsWith("kh") &&
                !isFrontVowel(lower[1]) &&
                !isY(lower[1]) &&
                !isCapitalized
              )
                errorType = "Sai quy tắc k";
              else if (
                lower.startsWith("c") &&
                !lower.startsWith("ch") &&
                (isFrontVowel(lower[1]) || isY(lower[1])) &&
                !isCapitalized
              )
                errorType = "Sai quy tắc c";
            }

            if (errorType) {
              const key = lower + "::" + errorType;
              if (!errorMap.has(key)) {
                errorMap.set(key, {
                  id: key,
                  word: word,
                  type: errorType,
                  contexts: [],
                });
              }
              errorMap
                .get(key)
                .contexts.push(getContext(para, match.index, word.length));
            }
          }
        });

        statTotalWords.innerText = totalWords.toLocaleString();
        allDetectedErrors = Array.from(errorMap.values()).sort(
          (a, b) => b.contexts.length - a.contexts.length
        );
        currentFilteredErrors = allDetectedErrors;
        filterAndRenderErrors();
      }

      function filterAndRenderErrors() {
        const rawInput = whitelistInput.value;
        const userWhitelist = new Set();
        if (rawInput) {
          const tokens = rawInput
            .split(/[\n,\t]+/)
            .map((t) => t.trim().toLowerCase())
            .filter((t) => t.length > 0);
          tokens.forEach((t) => userWhitelist.add(t));
        }
        let filteredErrors = allDetectedErrors.filter(
          (group) => !userWhitelist.has(group.word.toLowerCase())
        );
        if (isEngFilterEnabled && isEngDictLoaded) {
          filteredErrors = filteredErrors.filter(
            (group) => !engWords.has(group.word.toLowerCase())
          );
        }
        currentFilteredErrors = filteredErrors;
        const totalErrors = filteredErrors.reduce(
          (acc, curr) => acc + curr.contexts.length,
          0
        );
        statErrors.innerText = totalErrors.toLocaleString();
        statGroups.innerText = filteredErrors.length.toLocaleString();
        renderErrors(filteredErrors);
      }

      function quickIgnore(word) {
        // 1. Capture current index
        let targetIndex = -1;
        if (currentGroup) {
          targetIndex = currentFilteredErrors.findIndex(
            (g) => g.id === currentGroup.id
          );
        }

        // 2. Add to whitelist
        const currentVal = whitelistInput.value;
        const separator = currentVal.trim() ? ", " : "";
        whitelistInput.value = currentVal + separator + word;
        saveWhitelist();

        // 3. Re-filter
        filterAndRenderErrors();

        // 4. Restore selection to the same index (or closest)
        if (targetIndex !== -1 && currentFilteredErrors.length > 0) {
          // Ensure index is within bounds
          if (targetIndex >= currentFilteredErrors.length) {
            targetIndex = currentFilteredErrors.length - 1;
          }

          const nextGroup = currentFilteredErrors[targetIndex];

          // Select data
          selectGroup(nextGroup, null);

          // Select visual (wait for DOM update)
          setTimeout(() => {
            const listContainer = document.getElementById("error-list");
            const buttons = listContainer.querySelectorAll(".select-btn");
            if (buttons[targetIndex]) {
              buttons[targetIndex].scrollIntoView({
                block: "nearest",
                behavior: "smooth",
              });
              // Add style manually since selectGroup was called with null
              buttons[targetIndex].classList.add(
                "bg-blue-900/30",
                "border-blue-700/50",
                "ring-1",
                "ring-blue-500/50"
              );
              buttons[targetIndex].classList.remove(
                "border-transparent",
                "border-r"
              );
            }
          }, 0);
        } else if (currentFilteredErrors.length === 0) {
          // Clear view if list empty
          contextView.innerHTML =
            '<div class="text-center p-6 border-2 border-dashed border-slate-800 rounded-xl"><p class="text-lg mb-2">Tuyệt vời!</p><p class="text-sm opacity-60">Đã xử lý hết lỗi.</p></div>';
          contextNav.classList.add("hidden");
          currentGroup = null;
        }
      }

      function levenshteinDistance(a, b) {
        if (a.length === 0) return b.length;
        if (b.length === 0) return a.length;
        const matrix = [];
        for (let i = 0; i <= b.length; i++) matrix[i] = [i];
        for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
        for (let i = 1; i <= b.length; i++) {
          for (let j = 1; j <= a.length; j++) {
            if (b.charAt(i - 1) === a.charAt(j - 1))
              matrix[i][j] = matrix[i - 1][j - 1];
            else
              matrix[i][j] = Math.min(
                matrix[i - 1][j - 1] + 1,
                Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1)
              );
          }
        }
        return matrix[b.length][a.length];
      }

      function findSuggestions(wrongWord) {
        const lowerWrong = wrongWord.toLowerCase();
        for (const [wrong, right] of Object.entries(TONE_MISPLACEMENT)) {
          if (lowerWrong.includes(wrong)) {
            return [lowerWrong.replace(wrong, right)];
          }
        }
        if (!isDictLoaded) return [];
        const suggestions = [];
        const maxDistance = wrongWord.length < 4 ? 1 : 2;
        for (const word of validSyllables) {
          if (Math.abs(word.length - lowerWrong.length) > maxDistance) continue;
          const dist = levenshteinDistance(lowerWrong, word);
          if (dist <= maxDistance && dist > 0) suggestions.push({ word, dist });
        }
        return suggestions
          .sort((a, b) => a.dist - b.dist)
          .slice(0, 5)
          .map((s) => s.word);
      }

      function getContext(text, index, length) {
        const start = Math.max(0, index - 60);
        const end = Math.min(text.length, index + length + 60);
        let prefix = text.substring(start, index);
        let suffix = text.substring(index + length, end);
        if (start > 0) prefix = "..." + prefix;
        if (end < text.length) suffix = suffix + "...";
        return { prefix, target: text.substr(index, length), suffix };
      }

      function copyToClipboard(text) {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.style.position = "fixed";
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand("copy");
          const notification = document.createElement("div");
          notification.className =
            "fixed bottom-6 right-6 bg-slate-800 text-green-400 border border-slate-700 px-4 py-3 rounded-lg shadow-xl z-50 text-sm font-medium animate-fadeIn flex items-center gap-2";
          notification.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg><span>Đã copy: "${text}"</span>`;
          document.body.appendChild(notification);
          setTimeout(() => {
            notification.style.opacity = "0";
            notification.style.transition = "opacity 0.5s ease";
            setTimeout(() => notification.remove(), 500);
          }, 2000);
        } catch (err) {}
        document.body.removeChild(textarea);
      }

      function renderErrors(groups) {
        errorList.innerHTML = "";
        if (currentGroup) {
          const stillExists = groups.find((g) => g.id === currentGroup.id);
          if (!stillExists) {
            contextView.innerHTML =
              '<div class="text-center p-6 border-2 border-dashed border-slate-800 rounded-xl"><p class="text-lg mb-2">Chưa chọn lỗi nào</p><p class="text-sm opacity-60">Chọn một mục từ danh sách bên trái</p></div>';
            contextNav.classList.add("hidden");
            currentGroup = null;
          }
        }
        if (groups.length === 0) {
          errorList.innerHTML =
            '<div class="p-10 text-center text-slate-600 flex flex-col items-center"><svg class="w-16 h-16 mb-4 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="text-lg font-medium">Tuyệt vời!</p><p class="text-sm mt-1">Không tìm thấy lỗi nào (hoặc đã được lọc hết).</p></div>';
          return;
        }
        const template = document.getElementById("error-item-template");
        groups.forEach((group) => {
          const clone = template.content.cloneNode(true);
          clone.querySelector(".error-word").innerText = group.word;
          clone.querySelector(".error-reason").innerText = group.type;
          clone.querySelector(".error-count").innerText = group.contexts.length;
          const style = getErrorHighlights(group.type);
          const dot = clone.querySelector(".status-dot");
          dot.classList.add(style.dot);
          const selectBtn = clone.querySelector(".select-btn");
          if (currentGroup && currentGroup.id === group.id) {
            selectBtn.classList.add(
              "bg-blue-900/30",
              "border-blue-700/50",
              "ring-1",
              "ring-blue-500/50"
            );
            selectBtn.classList.remove("border-transparent", "border-r");
          }
          selectBtn.onclick = (e) => {
            selectGroup(group, selectBtn);
            copyToClipboard(group.word);
          };
          const ignoreBtn = clone.querySelector(".ignore-btn");
          ignoreBtn.onclick = (e) => {
            e.stopPropagation();
            quickIgnore(group.word);
          };
          errorList.appendChild(clone);
        });
      }

      function selectGroup(group, btnElement) {
        currentGroup = group;
        currentInstanceIndex = 0;
        const allItems = document.querySelectorAll("#error-list .select-btn");
        allItems.forEach((btn) => {
          btn.classList.remove(
            "bg-blue-900/30",
            "border-blue-700/50",
            "ring-1",
            "ring-blue-500/50"
          );
          btn.classList.add("border-transparent", "border-r");
        });
        if (btnElement) {
          btnElement.classList.add(
            "bg-blue-900/30",
            "border-blue-700/50",
            "ring-1",
            "ring-blue-500/50"
          );
          btnElement.classList.remove("border-transparent", "border-r");
        }
        if (group.contexts.length > 1) contextNav.classList.remove("hidden");
        else contextNav.classList.add("hidden");
        updateContextView();
      }

      function updateContextView() {
        if (!currentGroup) return;
        const context = currentGroup.contexts[currentInstanceIndex];
        const total = currentGroup.contexts.length;
        const suggestions = findSuggestions(currentGroup.word);
        const suggestionHTML =
          suggestions.length > 0
            ? `<div class="mt-4 flex flex-wrap justify-center gap-2">
                     <span class="text-sm text-slate-400 mr-1 self-center">Gợi ý:</span>
                     ${suggestions
                       .map(
                         (s) =>
                           `<span class="bg-green-900/30 text-green-400 border border-green-700/50 px-2 py-1 rounded text-sm cursor-pointer hover:bg-green-800/50">${s}</span>`
                       )
                       .join("")}
                   </div>`
            : "";
        const style = getErrorHighlights(currentGroup.type);
        const reasonHTML = `<div class="px-5 py-3 bg-slate-800 text-slate-300 rounded-lg text-sm border border-slate-700 shadow-lg flex items-center gap-3">
                    <span class="w-3 h-3 rounded-full ${style.dot} shadow-[0_0_8px_currentColor]"></span>
                    <span class="text-slate-200 font-medium">${currentGroup.type}</span>
               </div>`;
        navIndicator.innerText = `${currentInstanceIndex + 1}/${total}`;
        btnPrev.disabled = currentInstanceIndex === 0;
        btnNext.disabled = currentInstanceIndex === total - 1;
        const wiktionaryLink = `<a href="https://vi.wiktionary.org/wiki/${currentGroup.word}" target="_blank" class="ml-1 inline-flex items-center text-blue-400 hover:text-blue-300 transition-colors" title="Tra cứu Wiktionary"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></a>`;
        contextView.innerHTML = `
                <div class="max-w-2xl text-center w-full animate-fadeIn">
                    <div class="flex items-center justify-center gap-2 mb-6">
                        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest bg-slate-800 px-2 py-1 rounded">
                            Ngữ cảnh ${currentInstanceIndex + 1} / ${total}
                        </span>
                    </div>
                    <div class="bg-slate-900 p-8 rounded-xl border border-slate-800 shadow-inner relative">
                        <div class="text-xl leading-loose text-slate-300 font-serif">
                            ${escapeHtml(context.prefix)}<span class="${
          style.bg
        } ${style.text} px-1 py-0.5 rounded border-b-2 ${
          style.border
        } font-bold mx-0.5 shadow-[0_0_15px_rgba(0,0,0,0.2)]">${escapeHtml(
          context.target
        )} ${wiktionaryLink}</span>${escapeHtml(context.suffix)}
                        </div>
                    </div>
                    <div class="mt-8 flex flex-col items-center justify-center gap-4">
                        ${reasonHTML}
                        ${suggestionHTML}
                    </div>
                </div>
            `;
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
  </body>
</html>
